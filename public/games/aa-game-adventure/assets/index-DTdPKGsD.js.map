{"version":3,"file":"index-DTdPKGsD.js","sources":["../../src/config.ts","../../src/adapters/canvas.ts","../../src/adapters/input.ts","../../src/adapters/loop.ts","../../src/utils/assert.ts","../../src/engine/state.ts","../../src/adapters/renderer/glyphs.ts","../../src/adapters/renderer/draw.ts","../../src/adapters/renderer/hud.ts","../../src/dev/overlay.ts","../../src/engine/map.ts","../../src/engine/commands.ts","../../src/engine/step.ts","../../src/engine/schema.ts","../../src/engine/systems/movement.ts","../../src/engine/systems/clock.ts","../../src/engine/systems/interaction.ts","../../src/engine/systems/inventory.ts","../../src/engine/systems/chest.ts","../../src/engine/systems/door.ts","../../src/engine/registry.ts","../../src/mods/combat/rules.ts","../../src/mods/combat/index.ts","../../src/mods/shop/index.ts","../../src/mods/procedural/index.ts","../../src/dev/playtest.ts","../../src/dev/menu.ts","../../src/adapters/dev/aiConsole.ts","../../src/main.ts"],"sourcesContent":["/**\r\n * Game configuration and tunables.\r\n */\r\n\r\nexport const config = {\r\n  // Rendering\r\n  tileSize: 32,\r\n  palette: {\r\n    floor: '#3a3a3a',\r\n    wall: '#1a1a1a',\r\n    player: '#4a9eff',\r\n    npc: '#ffaa44',\r\n    chest: '#8b4513',\r\n    door: '#654321',\r\n    portal: '#9b59b6',\r\n    text: '#ffffff',\r\n    bg: '#1a1a1a',\r\n  },\r\n  \r\n  // Simulation\r\n  fixedStepMs: 16.6667, // 60 FPS\r\n  maxStepTimeMs: 100, // clamp to avoid spiral of death\r\n  \r\n  // Keybinds\r\n  keys: {\r\n    moveNorth: ['KeyW', 'ArrowUp'],\r\n    moveSouth: ['KeyS', 'ArrowDown'],\r\n    moveEast: ['KeyD', 'ArrowRight'],\r\n    moveWest: ['KeyA', 'ArrowLeft'],\r\n    interact: ['KeyE', 'Space'],\r\n    inventory: ['KeyI'],\r\n    save: ['KeyF5'],\r\n    load: ['KeyF9'],\r\n    devOverlay: ['F1'],\r\n  },\r\n  \r\n  // Mobile\r\n  touchDeadzone: 20,\r\n  touchRepeatMs: 150,\r\n  \r\n  // Dev flags\r\n  DEV_CHECKS: (import.meta as any).env?.DEV ?? true,\r\n  SHOW_GRID: false,\r\n  SHOW_COLLIDERS: false,\r\n  REDUCED_MOTION: false,\r\n  \r\n  // Plugins (loadable modules)\r\n  plugins: ['combat', 'shop'] as const,\r\n} as const;\r\n\r\nexport type Config = typeof config;\r\n\r\n","/**\r\n * Canvas adapter with DPR handling and render surface management.\r\n */\r\n\r\nimport { config } from '../config';\r\n\r\nexport interface CanvasAdapter {\r\n  canvas: HTMLCanvasElement;\r\n  ctx: CanvasRenderingContext2D;\r\n  width: number;\r\n  height: number;\r\n  dpr: number;\r\n  resize: () => void;\r\n}\r\n\r\n/**\r\n * Create canvas adapter with DPR handling.\r\n */\r\nexport function createCanvas(canvas: HTMLCanvasElement): CanvasAdapter {\r\n  let dpr = window.devicePixelRatio || 1;\r\n  let width = canvas.clientWidth;\r\n  let height = canvas.clientHeight;\r\n  \r\n  function resize(): void {\r\n    dpr = window.devicePixelRatio || 1;\r\n    width = canvas.clientWidth;\r\n    height = canvas.clientHeight;\r\n    \r\n    canvas.width = width * dpr;\r\n    canvas.height = height * dpr;\r\n    \r\n    const ctx = canvas.getContext('2d');\r\n    if (ctx) {\r\n      ctx.scale(dpr, dpr);\r\n      ctx.imageSmoothingEnabled = false;\r\n    }\r\n  }\r\n  \r\n  resize();\r\n  \r\n  const ctx = canvas.getContext('2d');\r\n  if (!ctx) {\r\n    throw new Error('Failed to get 2D context');\r\n  }\r\n  \r\n  ctx.scale(dpr, dpr);\r\n  ctx.imageSmoothingEnabled = false;\r\n  \r\n  return {\r\n    canvas,\r\n    ctx,\r\n    get width() { return width; },\r\n    get height() { return height; },\r\n    get dpr() { return dpr; },\r\n    resize,\r\n  };\r\n}\r\n\r\n","/**\r\n * Input adapter - keyboard and touch to Intent.\r\n */\r\n\r\nimport type { Intent } from '../types';\r\nimport { config } from '../config';\r\n\r\nexport interface InputAdapter {\r\n  getIntent: () => Intent;\r\n  destroy: () => void;\r\n}\r\n\r\n/**\r\n * Create input adapter.\r\n */\r\nexport function createInput(canvas: HTMLCanvasElement): InputAdapter {\r\n  let currentIntent: Intent = { type: 'None' };\r\n  const keys = new Set<string>();\r\n  let touchStart: { x: number; y: number } | null = null;\r\n  let touchRepeatTimer: number | null = null;\r\n  \r\n  function handleKeyDown(e: KeyboardEvent): void {\r\n    keys.add(e.code);\r\n    updateIntent();\r\n  }\r\n  \r\n  function handleKeyUp(e: KeyboardEvent): void {\r\n    keys.delete(e.code);\r\n    updateIntent();\r\n  }\r\n  \r\n  function updateIntent(): void {\r\n    if (config.keys.moveNorth.some(k => keys.has(k))) {\r\n      currentIntent = { type: 'Move', direction: 'north' };\r\n    } else if (config.keys.moveSouth.some(k => keys.has(k))) {\r\n      currentIntent = { type: 'Move', direction: 'south' };\r\n    } else if (config.keys.moveEast.some(k => keys.has(k))) {\r\n      currentIntent = { type: 'Move', direction: 'east' };\r\n    } else if (config.keys.moveWest.some(k => keys.has(k))) {\r\n      currentIntent = { type: 'Move', direction: 'west' };\r\n    } else if (config.keys.interact.some(k => keys.has(k))) {\r\n      currentIntent = { type: 'Interact' };\r\n    } else if (config.keys.inventory.some(k => keys.has(k))) {\r\n      currentIntent = { type: 'OpenInventory' };\r\n    } else if (config.keys.save.some(k => keys.has(k))) {\r\n      currentIntent = { type: 'Save' };\r\n    } else if (config.keys.load.some(k => keys.has(k))) {\r\n      currentIntent = { type: 'Load' };\r\n    } else {\r\n      currentIntent = { type: 'None' };\r\n    }\r\n  }\r\n  \r\n  function handleTouchStart(e: TouchEvent): void {\r\n    e.preventDefault();\r\n    if (e.touches.length > 0) {\r\n      touchStart = { x: e.touches[0].clientX, y: e.touches[0].clientY };\r\n    }\r\n  }\r\n  \r\n  function handleTouchMove(e: TouchEvent): void {\r\n    e.preventDefault();\r\n    if (!touchStart || e.touches.length === 0) return;\r\n    \r\n    const touch = e.touches[0];\r\n    const dx = touch.clientX - touchStart.x;\r\n    const dy = touch.clientY - touchStart.y;\r\n    const deadzone = config.touchDeadzone;\r\n    \r\n    if (Math.abs(dx) > Math.abs(dy)) {\r\n      if (dx > deadzone) {\r\n        currentIntent = { type: 'Move', direction: 'east' };\r\n      } else if (dx < -deadzone) {\r\n        currentIntent = { type: 'Move', direction: 'west' };\r\n      }\r\n    } else {\r\n      if (dy > deadzone) {\r\n        currentIntent = { type: 'Move', direction: 'south' };\r\n      } else if (dy < -deadzone) {\r\n        currentIntent = { type: 'Move', direction: 'north' };\r\n      }\r\n    }\r\n    \r\n    // Repeat movement\r\n    if (touchRepeatTimer) clearTimeout(touchRepeatTimer);\r\n    touchRepeatTimer = window.setTimeout(() => {\r\n      updateIntent();\r\n    }, config.touchRepeatMs);\r\n  }\r\n  \r\n  function handleTouchEnd(e: TouchEvent): void {\r\n    e.preventDefault();\r\n    touchStart = null;\r\n    if (touchRepeatTimer) {\r\n      clearTimeout(touchRepeatTimer);\r\n      touchRepeatTimer = null;\r\n    }\r\n    currentIntent = { type: 'None' };\r\n  }\r\n  \r\n  window.addEventListener('keydown', handleKeyDown);\r\n  window.addEventListener('keyup', handleKeyUp);\r\n  canvas.addEventListener('touchstart', handleTouchStart, { passive: false });\r\n  canvas.addEventListener('touchmove', handleTouchMove, { passive: false });\r\n  canvas.addEventListener('touchend', handleTouchEnd, { passive: false });\r\n  \r\n  return {\r\n    getIntent: () => currentIntent,\r\n    destroy: () => {\r\n      window.removeEventListener('keydown', handleKeyDown);\r\n      window.removeEventListener('keyup', handleKeyUp);\r\n      canvas.removeEventListener('touchstart', handleTouchStart);\r\n      canvas.removeEventListener('touchmove', handleTouchMove);\r\n      canvas.removeEventListener('touchend', handleTouchEnd);\r\n      if (touchRepeatTimer) clearTimeout(touchRepeatTimer);\r\n    },\r\n  };\r\n}\r\n\r\n","/**\r\n * Fixed-step game loop with accumulator and time clamping.\r\n */\r\n\r\nimport type { GameState, Intent } from '../types';\r\nimport { config } from '../config';\r\nimport { step } from '../engine/step';\r\nimport type { SystemFn } from '../types';\r\n\r\nexport interface LoopCallbacks {\r\n  onStep: (state: GameState, intent: Intent) => GameState;\r\n  onRender: (state: GameState) => void;\r\n}\r\n\r\n/**\r\n * Create and run fixed-step game loop.\r\n */\r\nexport interface GameLoop {\r\n  setIntent: (intent: Intent) => void;\r\n  stop: () => void;\r\n}\r\n\r\nexport function createGameLoop(\r\n  initialState: GameState,\r\n  systems: readonly SystemFn[],\r\n  callbacks: LoopCallbacks,\r\n  getIntent: () => Intent\r\n): GameLoop {\r\n  let state = initialState;\r\n  let accumulator = 0;\r\n  let lastTime = performance.now();\r\n  \r\n  const stepMs = config.fixedStepMs;\r\n  const maxStepMs = config.maxStepTimeMs;\r\n  \r\n  let currentIntent: Intent = { type: 'None' };\r\n  \r\n  function frame(now: number): void {\r\n    const deltaMs = Math.min(now - lastTime, maxStepMs);\r\n    lastTime = now;\r\n    accumulator += deltaMs;\r\n    \r\n    // Get current intent from input\r\n    currentIntent = getIntent();\r\n    \r\n    // Run simulation steps\r\n    while (accumulator >= stepMs) {\r\n      state = callbacks.onStep(state, currentIntent);\r\n      accumulator -= stepMs;\r\n      currentIntent = { type: 'None' }; // Reset after step\r\n    }\r\n    \r\n    // Render\r\n    callbacks.onRender(state);\r\n    \r\n    requestAnimationFrame(frame);\r\n  }\r\n  \r\n  const rafId = requestAnimationFrame(frame);\r\n  \r\n  return {\r\n    setIntent: (intent: Intent) => {\r\n      currentIntent = intent;\r\n    },\r\n    stop: () => {\r\n      cancelAnimationFrame(rafId);\r\n    },\r\n  };\r\n}\r\n\r\n","/**\r\n * Runtime assertion utilities with clear error messages.\r\n */\r\n\r\nexport function assert(condition: boolean, message: string): asserts condition {\r\n  if (!condition) {\r\n    throw new Error(`Assertion failed: ${message}`);\r\n  }\r\n}\r\n\r\nexport function assertDefined<T>(value: T | undefined | null, message: string): asserts value is T {\r\n  if (value === undefined || value === null) {\r\n    throw new Error(`Assertion failed: ${message} (value was ${value})`);\r\n  }\r\n}\r\n\r\nexport function assertInvariant(condition: boolean, invariant: string): void {\r\n  if (!condition) {\r\n    throw new Error(`Invariant violation: ${invariant}`);\r\n  }\r\n}\r\n\r\n","/**\r\n * Canonical game state with constructors and immutable updaters.\r\n * \r\n * This module defines GameState as the single source of truth for all game logic.\r\n * All state mutations flow through updater functions (updateEntity, updateEntities, setQuestFlag)\r\n * which return new state objects. Invariants (unique IDs, bounds checks, occupancy rules)\r\n * are enforced via assertions during state construction and updates.\r\n */\r\n\r\nimport type { Entity, EntityId, GameState, PlayerEntity, Position, QuestFlags, ClockState } from '../types';\r\nimport { assert, assertDefined, assertInvariant } from '../utils/assert';\r\n\r\n/** Tile type constants. */\r\nexport const TILE_FLOOR = 0;\r\nexport const TILE_WALL = 1;\r\nexport const TILE_PORTAL = 2;\r\n\r\n/**\r\n * Create a new game state.\r\n */\r\nexport function createState(params: {\r\n  version: number;\r\n  seed: number;\r\n  mapId: string;\r\n  mapWidth: number;\r\n  mapHeight: number;\r\n  tiles: readonly number[];\r\n  entities: readonly Entity[];\r\n  playerId: EntityId;\r\n  questFlags?: QuestFlags;\r\n}): GameState {\r\n  const entitiesById = new Map<EntityId, Entity>();\r\n  for (const entity of params.entities) {\r\n    entitiesById.set(entity.id, entity);\r\n  }\r\n  \r\n  return {\r\n    version: params.version,\r\n    seed: params.seed,\r\n    tick: 0,\r\n    mapId: params.mapId,\r\n    mapWidth: params.mapWidth,\r\n    mapHeight: params.mapHeight,\r\n    tiles: params.tiles,\r\n    entities: params.entities,\r\n    entitiesById,\r\n    playerId: params.playerId,\r\n    questFlags: params.questFlags ?? {},\r\n    clock: createClock(0),\r\n  };\r\n}\r\n\r\n/**\r\n * Create clock state from time in seconds.\r\n */\r\nexport function createClock(time: number): ClockState {\r\n  const totalMinutes = Math.floor(time / 60);\r\n  const day = Math.floor(totalMinutes / (24 * 60));\r\n  const hour = Math.floor((totalMinutes % (24 * 60)) / 60);\r\n  const minute = totalMinutes % 60;\r\n  \r\n  return { time, day, hour, minute };\r\n}\r\n\r\n/**\r\n * Update state with new entities (immutable).\r\n */\r\nexport function updateEntities(state: GameState, entities: readonly Entity[]): GameState {\r\n  const entitiesById = new Map<EntityId, Entity>();\r\n  for (const entity of entities) {\r\n    entitiesById.set(entity.id, entity);\r\n  }\r\n  for (const entity of entities) {\r\n    entitiesById.set(entity.id, entity);\r\n  }\r\n  \r\n  return {\r\n    ...state,\r\n    entities,\r\n    entitiesById,\r\n  };\r\n}\r\n\r\n/**\r\n * Update a single entity (immutable).\r\n */\r\nexport function updateEntity(state: GameState, id: EntityId, updater: (e: Entity) => Entity): GameState {\r\n  const entity = state.entitiesById.get(id);\r\n  assertDefined(entity, `Entity ${id} not found`);\r\n  \r\n  const updated = updater(entity);\r\n  const entities = state.entities.map(e => e.id === id ? updated : e);\r\n  return updateEntities(state, entities);\r\n}\r\n\r\n/**\r\n * Set quest flag (immutable).\r\n */\r\nexport function setQuestFlag(state: GameState, key: string, value: boolean): GameState {\r\n  return {\r\n    ...state,\r\n    questFlags: { ...state.questFlags, [key]: value },\r\n  };\r\n}\r\n\r\n/**\r\n * Get player entity.\r\n */\r\nexport function getPlayer(state: GameState): PlayerEntity {\r\n  const player = state.entitiesById.get(state.playerId);\r\n  assertDefined(player, 'Player entity not found');\r\n  assert(player.tag === 'Player', 'Player entity has wrong tag');\r\n  return player as PlayerEntity;\r\n}\r\n\r\n/**\r\n * Assert all state invariants (dev mode only).\r\n */\r\nexport function assertInvariants(state: GameState): void {\r\n  // Unique entity IDs\r\n  assertInvariant(\r\n    state.entitiesById.size === state.entities.length,\r\n    'entitiesById.size must equal entities.length'\r\n  );\r\n  \r\n  // Player exists\r\n  const player = state.entitiesById.get(state.playerId);\r\n  assertInvariant(player !== undefined, 'playerId must reference an existing entity');\r\n  assertInvariant(player?.tag === 'Player', 'playerId must reference a Player entity');\r\n  \r\n  // Positions within bounds\r\n  for (const entity of state.entities) {\r\n    assertInvariant(\r\n      entity.position.x >= 0 && entity.position.x < state.mapWidth &&\r\n      entity.position.y >= 0 && entity.position.y < state.mapHeight,\r\n      `Entity ${entity.id} position (${entity.position.x}, ${entity.position.y}) out of bounds`\r\n    );\r\n  }\r\n  \r\n  // Occupancy: at most one solid entity per tile\r\n  const occupancy = new Map<string, EntityId[]>();\r\n  for (const entity of state.entities) {\r\n    if (entity.solid) {\r\n      const key = `${entity.position.x},${entity.position.y}`;\r\n      const list = occupancy.get(key) ?? [];\r\n      list.push(entity.id);\r\n      occupancy.set(key, list);\r\n    }\r\n  }\r\n  for (const [pos, ids] of occupancy) {\r\n    assertInvariant(ids.length <= 1, `Multiple solid entities at ${pos}: ${ids.join(', ')}`);\r\n  }\r\n  \r\n  // Inventory counts are integers >= 0\r\n  const playerEntity = getPlayer(state);\r\n  for (const stack of playerEntity.inventory.items) {\r\n    assertInvariant(\r\n      Number.isInteger(stack.count) && stack.count >= 0,\r\n      `Invalid inventory count for ${stack.itemId}: ${stack.count}`\r\n    );\r\n  }\r\n}\r\n\r\n","/**\r\n * Glyph/icons for entities (doors, chests, NPCs, etc.).\r\n */\r\n\r\nimport type { Entity } from '../../types';\r\n\r\n/**\r\n * Draw glyph for an entity.\r\n */\r\nexport function drawGlyph(\r\n  ctx: CanvasRenderingContext2D,\r\n  entity: Entity,\r\n  x: number,\r\n  y: number,\r\n  size: number\r\n): void {\r\n  ctx.fillStyle = '#ffffff';\r\n  ctx.font = `${size * 0.6}px monospace`;\r\n  ctx.textAlign = 'center';\r\n  ctx.textBaseline = 'middle';\r\n  \r\n  let glyph = '?';\r\n  if (entity.tag === 'Player') glyph = '@';\r\n  else if (entity.tag === 'NPC') glyph = 'N';\r\n  else if (entity.tag === 'Chest') {\r\n    glyph = (entity as any).metadata?.opened ? '=' : 'C';\r\n  } else if (entity.tag === 'Door') {\r\n    glyph = (entity as any).metadata?.locked ? '#' : '/';\r\n  } else if (entity.tag === 'Portal') glyph = 'O';\r\n  else if (entity.tag === 'Item') glyph = 'i';\r\n  \r\n  ctx.fillText(glyph, x + size / 2, y + size / 2);\r\n}\r\n\r\n","/**\r\n * Stateless canvas drawing from RenderSnapshot.\r\n */\r\n\r\nimport type { RenderSnapshot, Entity, Position } from '../../types';\r\nimport { config } from '../../config';\r\nimport { TILE_FLOOR, TILE_WALL, TILE_PORTAL } from '../../engine/state';\r\nimport { drawGlyph } from './glyphs';\r\n\r\n/**\r\n * Draw game state to canvas.\r\n */\r\nexport function draw(ctx: CanvasRenderingContext2D, snap: RenderSnapshot): void {\r\n  const { state } = snap;\r\n  const tileSize = config.tileSize;\r\n  \r\n  // Clear\r\n  ctx.fillStyle = config.palette.bg;\r\n  ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);\r\n  \r\n  // Draw grid if enabled\r\n  if (config.SHOW_GRID) {\r\n    drawGrid(ctx, state.mapWidth, state.mapHeight, tileSize);\r\n  }\r\n  \r\n  // Draw tiles\r\n  for (let y = 0; y < state.mapHeight; y++) {\r\n    for (let x = 0; x < state.mapWidth; x++) {\r\n      const tile = state.tiles[y * state.mapWidth + x];\r\n      const px = x * tileSize;\r\n      const py = y * tileSize;\r\n      \r\n      if (tile === TILE_FLOOR) {\r\n        ctx.fillStyle = config.palette.floor;\r\n      } else if (tile === TILE_WALL) {\r\n        ctx.fillStyle = config.palette.wall;\r\n      } else if (tile === TILE_PORTAL) {\r\n        ctx.fillStyle = config.palette.portal;\r\n      } else {\r\n        ctx.fillStyle = config.palette.floor;\r\n      }\r\n      \r\n      ctx.fillRect(px, py, tileSize, tileSize);\r\n    }\r\n  }\r\n  \r\n  // Draw entities\r\n  for (const entity of state.entities) {\r\n    drawEntity(ctx, entity, tileSize);\r\n  }\r\n  \r\n  // Draw colliders if enabled\r\n  if (config.SHOW_COLLIDERS) {\r\n    drawColliders(ctx, state.entities, tileSize);\r\n  }\r\n}\r\n\r\n/**\r\n * Draw grid lines.\r\n */\r\nfunction drawGrid(ctx: CanvasRenderingContext2D, width: number, height: number, tileSize: number): void {\r\n  ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';\r\n  ctx.lineWidth = 1;\r\n  \r\n  for (let x = 0; x <= width; x++) {\r\n    ctx.beginPath();\r\n    ctx.moveTo(x * tileSize, 0);\r\n    ctx.lineTo(x * tileSize, height * tileSize);\r\n    ctx.stroke();\r\n  }\r\n  \r\n  for (let y = 0; y <= height; y++) {\r\n    ctx.beginPath();\r\n    ctx.moveTo(0, y * tileSize);\r\n    ctx.lineTo(width * tileSize, y * tileSize);\r\n    ctx.stroke();\r\n  }\r\n}\r\n\r\n/**\r\n * Draw an entity.\r\n */\r\nfunction drawEntity(ctx: CanvasRenderingContext2D, entity: Entity, tileSize: number): void {\r\n  const px = entity.position.x * tileSize;\r\n  const py = entity.position.y * tileSize;\r\n  \r\n  let color: string = config.palette.player;\r\n  if (entity.tag === 'NPC') color = config.palette.npc;\r\n  else if (entity.tag === 'Chest') color = config.palette.chest;\r\n  else if (entity.tag === 'Door') color = config.palette.door;\r\n  else if (entity.tag === 'Portal') color = config.palette.portal;\r\n  \r\n  ctx.fillStyle = color;\r\n  ctx.fillRect(px + 2, py + 2, tileSize - 4, tileSize - 4);\r\n  \r\n  // Draw glyph\r\n  drawGlyph(ctx, entity, px, py, tileSize);\r\n}\r\n\r\n/**\r\n * Draw collider outlines.\r\n */\r\nfunction drawColliders(ctx: CanvasRenderingContext2D, entities: readonly Entity[], tileSize: number): void {\r\n  ctx.strokeStyle = 'rgba(255, 0, 0, 0.5)';\r\n  ctx.lineWidth = 2;\r\n  \r\n  for (const entity of entities) {\r\n    if (entity.solid) {\r\n      const px = entity.position.x * tileSize;\r\n      const py = entity.position.y * tileSize;\r\n      ctx.strokeRect(px, py, tileSize, tileSize);\r\n    }\r\n  }\r\n}\r\n\r\n","/**\r\n * HUD rendering - bars, text, prompts.\r\n */\r\n\r\nimport type { HUDComposer, RenderSnapshot, Position } from '../../types';\r\nimport { config } from '../../config';\r\nimport { getPlayer } from '../../engine/state';\r\n\r\n/**\r\n * Create HUD composer.\r\n */\r\nexport function createHUDComposer(ctx: CanvasRenderingContext2D): HUDComposer {\r\n  const elements: Array<{\r\n    type: 'text' | 'bar' | 'prompt';\r\n    x: number;\r\n    y: number;\r\n    text?: string;\r\n    width?: number;\r\n    value?: number;\r\n    max?: number;\r\n    color?: string;\r\n    position?: Position;\r\n  }> = [];\r\n  \r\n  return {\r\n    addText(x: number, y: number, text: string, color?: string): void {\r\n      elements.push({ type: 'text', x, y, text, color });\r\n    },\r\n    addBar(x: number, y: number, width: number, value: number, max: number, color?: string): void {\r\n      elements.push({ type: 'bar', x, y, width, value, max, color });\r\n    },\r\n    addPrompt(text: string, position: Position): void {\r\n      elements.push({ type: 'prompt', x: 0, y: 0, text, position });\r\n    },\r\n    draw(): void {\r\n      for (const el of elements) {\r\n        if (el.type === 'text' && el.text) {\r\n          ctx.fillStyle = el.color ?? config.palette.text;\r\n          ctx.font = '14px monospace';\r\n          ctx.fillText(el.text, el.x, el.y);\r\n        } else if (el.type === 'bar' && el.value !== undefined && el.max !== undefined) {\r\n          const ratio = Math.max(0, Math.min(1, el.value / el.max));\r\n          ctx.fillStyle = el.color ?? '#ff0000';\r\n          ctx.fillRect(el.x, el.y, el.width! * ratio, 8);\r\n          ctx.strokeStyle = config.palette.text;\r\n          ctx.strokeRect(el.x, el.y, el.width!, 8);\r\n        } else if (el.type === 'prompt' && el.text && el.position) {\r\n          const tileSize = config.tileSize;\r\n          const px = el.position.x * tileSize;\r\n          const py = el.position.y * tileSize - 20;\r\n          ctx.fillStyle = config.palette.text;\r\n          ctx.font = '12px monospace';\r\n          ctx.textAlign = 'center';\r\n          ctx.fillText(el.text, px + tileSize / 2, py);\r\n        }\r\n      }\r\n    },\r\n  } as HUDComposer & { draw(): void };\r\n}\r\n\r\n/**\r\n * Draw HUD for game state.\r\n */\r\nexport function drawHUD(ctx: CanvasRenderingContext2D, snap: RenderSnapshot): void {\r\n  const hud = createHUDComposer(ctx);\r\n  const player = getPlayer(snap.state);\r\n  // Compute a safe left offset so HUD text doesn't get clipped by browser UI\r\n  const minViewportLeft = 40; // desired margin from viewport left to avoid browser chrome\r\n  let offsetX = 40; // default canvas-local x offset\r\n  try {\r\n    const canvasEl = ctx.canvas as HTMLCanvasElement;\r\n    const rect = canvasEl.getBoundingClientRect();\r\n    // If the canvas is too close to the viewport left edge, compute a canvas-local x\r\n    // so the HUD appears at least `minViewportLeft` CSS pixels from the viewport.\r\n    if (rect.left < minViewportLeft) {\r\n      offsetX = Math.ceil(minViewportLeft - rect.left);\r\n    } else {\r\n      offsetX = 16;\r\n    }\r\n    // Don't overflow the canvas area\r\n    const maxX = Math.max(16, Math.floor((canvasEl.width || canvasEl.clientWidth) - 80));\r\n    offsetX = Math.min(offsetX, maxX);\r\n  } catch (e) {\r\n    // ignore, fallback to default\r\n  }\r\n\r\n  // Inventory count\r\n  const itemCount = player.inventory.items.reduce((sum, stack) => sum + stack.count, 0);\r\n  hud.addText(offsetX, 20, `Items: ${itemCount}`, config.palette.text);\r\n\r\n  // Clock\r\n  const clock = snap.state.clock;\r\n  hud.addText(offsetX, 40, `Day ${clock.day} ${clock.hour}:${String(clock.minute).padStart(2, '0')}`, config.palette.text);\r\n  \r\n  // Interaction hints\r\n  for (const hint of snap.interactions) {\r\n    hud.addPrompt(hint.message, hint.position);\r\n  }\r\n  \r\n  // Let plugins add to HUD\r\n  // (would be called from main.ts with plugin hooks)\r\n  \r\n  (hud as any).draw();\r\n}\r\n\r\n","/**\r\n * Dev overlay (F1) - FPS, step time, entity counts, flags, playtest info.\r\n */\r\n\r\nimport type { GameState } from '../types';\r\nimport { config } from '../config';\r\n\r\nexport interface DevOverlay {\r\n  update: (state: GameState, fps: number, stepTime: number) => void;\r\n  setPlaytestMode: (enabled: boolean) => void;\r\n  setReplayActive: (active: boolean) => void;\r\n  toggle: () => void;\r\n  destroy: () => void;\r\n}\r\n\r\nlet overlayVisible = false;\r\nlet overlayEl: HTMLDivElement | null = null;\r\nlet playtestMode = false;\r\nlet replayActive = false;\r\n\r\n/**\r\n * Create dev overlay.\r\n */\r\nexport function createDevOverlay(): DevOverlay {\r\n  if (!overlayEl) {\r\n    overlayEl = document.createElement('div');\r\n    overlayEl.id = 'dev-overlay';\r\n    overlayEl.style.cssText = `\r\n      position: fixed;\r\n      top: 10px;\r\n      right: 10px;\r\n      background: rgba(0, 0, 0, 0.8);\r\n      color: #00ff00;\r\n      padding: 10px;\r\n      font-family: monospace;\r\n      font-size: 12px;\r\n      z-index: 9999;\r\n      border: 1px solid #00ff00;\r\n      display: none;\r\n      max-width: 300px;\r\n    `;\r\n    document.body.appendChild(overlayEl);\r\n  }\r\n  \r\n  function update(state: GameState, fps: number, stepTime: number): void {\r\n    if (!overlayEl || !overlayVisible) return;\r\n    \r\n    const lines = [\r\n      `FPS: ${fps.toFixed(1)}`,\r\n      `Step: ${stepTime.toFixed(2)}ms`,\r\n      `Tick: ${state.tick}`,\r\n      `Entities: ${state.entities.length}`,\r\n      `Map: ${state.mapId}`,\r\n      `Player: (${state.entities.find(e => e.id === state.playerId)?.position.x}, ${state.entities.find(e => e.id === state.playerId)?.position.y})`,\r\n      `Seed: ${state.seed}`,\r\n      `Flags: ${Object.keys(state.questFlags).length}`,\r\n      `Clock: Day ${state.clock.day} ${state.clock.hour}:${String(state.clock.minute).padStart(2, '0')}`,\r\n      '',\r\n      playtestMode ? '[PLAYTEST MODE]' : '',\r\n      replayActive ? '[REPLAY RECORDING]' : '',\r\n      playtestMode ? 'Commands: playtest.help()' : '',\r\n      '',\r\n      'Flags:',\r\n      ...Object.entries(state.questFlags).map(([k, v]) => `  ${k}: ${v}`),\r\n    ].filter(line => line !== '');\r\n    \r\n    overlayEl.textContent = lines.join('\\n');\r\n  }\r\n  \r\n  function toggle(): void {\r\n    overlayVisible = !overlayVisible;\r\n    if (overlayEl) {\r\n      overlayEl.style.display = overlayVisible ? 'block' : 'none';\r\n    }\r\n  }\r\n  \r\n  function destroy(): void {\r\n    if (overlayEl) {\r\n      overlayEl.remove();\r\n      overlayEl = null;\r\n    }\r\n  }\r\n  \r\n  function setPlaytestMode(enabled: boolean): void {\r\n    playtestMode = enabled;\r\n  }\r\n  \r\n  function setReplayActive(active: boolean): void {\r\n    replayActive = active;\r\n  }\r\n  \r\n  // Bind F1 key\r\n  window.addEventListener('keydown', (e) => {\r\n    if (e.code === 'F1') {\r\n      e.preventDefault();\r\n      toggle();\r\n    }\r\n  });\r\n  \r\n  return { update, toggle, destroy, setPlaytestMode, setReplayActive };\r\n}\r\n\r\n","/**\r\n * Map grid, collisions, and pathfinding utilities.\r\n */\r\n\r\nimport type { Entity, Position } from '../types';\r\nimport { TILE_FLOOR, TILE_WALL, TILE_PORTAL } from './state';\r\nimport { assert } from '../utils/assert';\r\n\r\n/**\r\n * Check if a position is within map bounds.\r\n */\r\nexport function inBounds(x: number, y: number, width: number, height: number): boolean {\r\n  return x >= 0 && x < width && y >= 0 && y < height;\r\n}\r\n\r\n/**\r\n * Get tile at position (returns TILE_WALL if out of bounds).\r\n */\r\nexport function getTile(\r\n  tiles: readonly number[],\r\n  x: number,\r\n  y: number,\r\n  width: number,\r\n  height: number\r\n): number {\r\n  if (!inBounds(x, y, width, height)) {\r\n    return TILE_WALL;\r\n  }\r\n  return tiles[y * width + x] ?? TILE_WALL;\r\n}\r\n\r\n/**\r\n * Check if a tile is walkable (floor or portal).\r\n */\r\nexport function isWalkable(tile: number): boolean {\r\n  return tile === TILE_FLOOR || tile === TILE_PORTAL;\r\n}\r\n\r\n/**\r\n * Check if a position is blocked by a solid entity.\r\n */\r\nexport function isBlocked(\r\n  pos: Position,\r\n  entities: readonly Entity[],\r\n  excludeId?: string\r\n): boolean {\r\n  for (const entity of entities) {\r\n    if (entity.id === excludeId) continue;\r\n    if (entity.solid && entity.position.x === pos.x && entity.position.y === pos.y) {\r\n      return true;\r\n    }\r\n  }\r\n  return false;\r\n}\r\n\r\n/**\r\n * Check if movement to a position is valid (bounds + tile + occupancy).\r\n */\r\nexport function canMoveTo(\r\n  pos: Position,\r\n  tiles: readonly number[],\r\n  width: number,\r\n  height: number,\r\n  entities: readonly Entity[],\r\n  excludeId?: string\r\n): boolean {\r\n  if (!inBounds(pos.x, pos.y, width, height)) {\r\n    return false;\r\n  }\r\n  \r\n  const tile = getTile(tiles, pos.x, pos.y, width, height);\r\n  if (!isWalkable(tile)) {\r\n    return false;\r\n  }\r\n  \r\n  if (isBlocked(pos, entities, excludeId)) {\r\n    return false;\r\n  }\r\n  \r\n  return true;\r\n}\r\n\r\n/**\r\n * Get Manhattan distance between two positions.\r\n */\r\nexport function manhattanDistance(a: Position, b: Position): number {\r\n  return Math.abs(a.x - b.x) + Math.abs(a.y - b.y);\r\n}\r\n\r\n/**\r\n * Check if two positions are adjacent (Manhattan distance <= 1).\r\n */\r\nexport function isAdjacent(a: Position, b: Position): boolean {\r\n  return manhattanDistance(a, b) <= 1;\r\n}\r\n\r\n/**\r\n * Move position by direction.\r\n */\r\nexport function movePosition(pos: Position, direction: 'north' | 'south' | 'east' | 'west'): Position {\r\n  switch (direction) {\r\n    case 'north': return { x: pos.x, y: pos.y - 1 };\r\n    case 'south': return { x: pos.x, y: pos.y + 1 };\r\n    case 'east': return { x: pos.x + 1, y: pos.y };\r\n    case 'west': return { x: pos.x - 1, y: pos.y };\r\n  }\r\n}\r\n\r\n/**\r\n * Simple pathfinding (A* would go here if needed).\r\n * For now, returns null (caller can use direct movement).\r\n */\r\nexport function findPath(\r\n  from: Position,\r\n  to: Position,\r\n  tiles: readonly number[],\r\n  width: number,\r\n  height: number,\r\n  entities: readonly Entity[]\r\n): Position[] | null {\r\n  // Minimal implementation: only direct path if unobstructed\r\n  if (manhattanDistance(from, to) === 1) {\r\n    if (canMoveTo(to, tiles, width, height, entities)) {\r\n      return [to];\r\n    }\r\n  }\r\n  return null;\r\n}\r\n\r\n","/**\r\n * Intent/command layer - idempotent handlers.\r\n */\r\n\r\nimport type { GameState, Intent } from '../types';\r\nimport { getPlayer, updateEntity } from './state';\r\nimport { movePosition, canMoveTo } from './map';\r\nimport type { CommandHandler } from '../types';\r\n\r\n/**\r\n * Handle Move intent (idempotent within one step).\r\n */\r\nexport function handleMove(state: GameState, intent: Intent): GameState {\r\n  if (intent.type !== 'Move') return state;\r\n  \r\n  const player = getPlayer(state);\r\n  const newPos = movePosition(player.position, intent.direction);\r\n  \r\n  if (!canMoveTo(\r\n    newPos,\r\n    state.tiles,\r\n    state.mapWidth,\r\n    state.mapHeight,\r\n    state.entities,\r\n    player.id\r\n  )) {\r\n    return state; // No change if blocked\r\n  }\r\n  \r\n  return updateEntity(state, player.id, (e) => ({\r\n    ...e,\r\n    position: newPos,\r\n    facing: intent.direction,\r\n  }));\r\n}\r\n\r\n/**\r\n * Handle Interact intent.\r\n */\r\nexport function handleInteract(state: GameState, intent: Intent): GameState {\r\n  if (intent.type !== 'Interact') return state;\r\n  \r\n  // Interaction is handled by systems, not here\r\n  // This is a no-op at command level\r\n  return state;\r\n}\r\n\r\n/**\r\n * Handle UseItem intent.\r\n */\r\nexport function handleUseItem(state: GameState, intent: Intent): GameState {\r\n  if (intent.type !== 'UseItem') return state;\r\n  \r\n  // Item usage handled by systems\r\n  return state;\r\n}\r\n\r\n/**\r\n * Default command handler (no-op).\r\n */\r\nexport function handleNone(state: GameState, intent: Intent): GameState {\r\n  return state;\r\n}\r\n\r\n/**\r\n * Command registry.\r\n */\r\nexport class CommandRegistry {\r\n  private handlers = new Map<string, CommandHandler>();\r\n  \r\n  constructor() {\r\n    this.register('Move', handleMove);\r\n    this.register('Interact', handleInteract);\r\n    this.register('UseItem', handleUseItem);\r\n    this.register('None', handleNone);\r\n  }\r\n  \r\n  register(type: string, handler: CommandHandler): void {\r\n    this.handlers.set(type, handler);\r\n  }\r\n  \r\n  handle(state: GameState, intent: Intent): GameState {\r\n    const handler = this.handlers.get(intent.type) ?? handleNone;\r\n    return handler(state, intent);\r\n  }\r\n}\r\n\r\n","/**\r\n * One fixed simulation step (pure function).\r\n */\r\n\r\nimport type { GameState, Intent } from '../types';\r\nimport { updateEntities } from './state';\r\nimport { CommandRegistry } from './commands';\r\nimport type { SystemFn } from '../types';\r\n\r\n/**\r\n * Execute one deterministic simulation step.\r\n * \r\n * Contract: Given the same (state, intent, systems), always returns identical results.\r\n * - Intent is converted to command(s) and executed first\r\n * - Systems run in registered order, each receiving and returning state\r\n * - Tick is incremented at the end\r\n * - Input state is NEVER mutated; all updates return new state objects\r\n * - Pure function: no DOM access, I/O, or random calls\r\n */\r\nexport function step(state: GameState, intent: Intent, systems: readonly SystemFn[]): GameState {\r\n  const commands = new CommandRegistry();\r\n  let next = commands.handle(state, intent);\r\n  \r\n  // Apply systems in order\r\n  for (const system of systems) {\r\n    next = system(next);\r\n  }\r\n  \r\n  // Increment tick\r\n  next = {\r\n    ...next,\r\n    tick: next.tick + 1,\r\n  };\r\n  \r\n  return next;\r\n}\r\n\r\n","/**\r\n * Map and save schema validation with versioning and migrations.\r\n */\r\n\r\nimport type { GameState } from '../types';\r\nimport { assert } from '../utils/assert';\r\n\r\n/** Map schema (v1). */\r\nexport interface MapSchemaV1 {\r\n  version: 1;\r\n  id: string;\r\n  width: number;\r\n  height: number;\r\n  tiles: number[];\r\n  entities: Array<{\r\n    id: string;\r\n    tag: string;\r\n    x: number;\r\n    y: number;\r\n    solid: boolean;\r\n    metadata?: Record<string, unknown>;\r\n  }>;\r\n  playerStart: { x: number; y: number };\r\n}\r\n\r\n/** Save schema (v1). */\r\nexport interface SaveSchemaV1 {\r\n  version: 1;\r\n  seed: number;\r\n  tick: number;\r\n  mapId: string;\r\n  playerPos: { x: number; y: number };\r\n  inventory: Array<{ itemId: string; count: number }>;\r\n  questFlags: Record<string, boolean>;\r\n  clock: { time: number; day: number; hour: number; minute: number };\r\n}\r\n\r\n/**\r\n * Validate map schema v1.\r\n */\r\nexport function validateMapSchema(data: unknown): MapSchemaV1 {\r\n  assert(typeof data === 'object' && data !== null, 'Map data must be an object');\r\n  const map = data as unknown as Record<string, unknown>;\r\n  \r\n  assert(map.version === 1, 'Map version must be 1');\r\n  assert(typeof map.id === 'string', 'Map id must be a string');\r\n  assert(typeof map.width === 'number' && map.width > 0, 'Map width must be a positive number');\r\n  assert(typeof map.height === 'number' && map.height > 0, 'Map height must be a positive number');\r\n  assert(Array.isArray(map.tiles), 'Map tiles must be an array');\r\n  assert(map.tiles.length === map.width * map.height, 'Map tiles length must match width * height');\r\n  assert(Array.isArray(map.entities), 'Map entities must be an array');\r\n  assert(\r\n    typeof map.playerStart === 'object' && map.playerStart !== null,\r\n    'Map playerStart must be an object'\r\n  );\r\n  \r\n  const playerStart = map.playerStart as Record<string, unknown>;\r\n  assert(typeof playerStart.x === 'number', 'Player start x must be a number');\r\n  assert(typeof playerStart.y === 'number', 'Player start y must be a number');\r\n  \r\n  return map as unknown as MapSchemaV1;\r\n}\r\n\r\n/**\r\n * Validate map content rules beyond basic schema:\r\n * - Unique entity IDs\r\n * - Entity positions within bounds\r\n * - Tag-specific required metadata (chestId, doorId, targetMap, npcId)\r\n */\r\nexport function validateMapContent(map: MapSchemaV1): void {\r\n  // Unique IDs\r\n  const ids = new Set<string>();\r\n  for (const e of map.entities) {\r\n    if (ids.has(e.id)) {\r\n      throw new Error(\r\n        `Duplicate entity id '${e.id}' in map '${map.id}'. Check your map JSON (data/maps/${map.id}.v1.json) and ensure entity IDs are unique.`\r\n      );\r\n    }\r\n    ids.add(e.id);\r\n  }\r\n\r\n  // Positions and tag-specific checks\r\n  for (const e of map.entities) {\r\n    if (e.x < 0 || e.x >= map.width || e.y < 0 || e.y >= map.height) {\r\n      throw new Error(\r\n        `Entity '${e.id}' is out of bounds at (${e.x},${e.y}) in map '${map.id}'. Check map dimensions (width=${map.width}, height=${map.height}) and entity coordinates.`\r\n      );\r\n    }\r\n\r\n    const meta = e.metadata ?? {};\r\n    if (e.tag === 'Chest') {\r\n      if (!meta || typeof meta['chestId'] !== 'string') {\r\n        throw new Error(\r\n          `Chest entity '${e.id}' missing required metadata.chestId in map '${map.id}'. Add a string metadata.chestId to the chest definition.`\r\n        );\r\n      }\r\n    }\r\n    if (e.tag === 'Door') {\r\n      if (!meta || typeof meta['doorId'] !== 'string') {\r\n        throw new Error(\r\n          `Door entity '${e.id}' missing required metadata.doorId in map '${map.id}'. Add a string metadata.doorId to the door definition.`\r\n        );\r\n      }\r\n    }\r\n    if (e.tag === 'Portal') {\r\n      if (!meta || typeof meta['targetMap'] !== 'string') {\r\n        throw new Error(\r\n          `Portal entity '${e.id}' missing required metadata.targetMap in map '${map.id}'. Add metadata.targetMap (string) to point to another map id.`\r\n        );\r\n      }\r\n    }\r\n    if (e.tag === 'NPC') {\r\n      if (!meta || typeof meta['npcId'] !== 'string') {\r\n        throw new Error(\r\n          `NPC entity '${e.id}' missing required metadata.npcId in map '${map.id}'. Add metadata.npcId (string) to identify the NPC.`\r\n        );\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Validate save schema v1.\r\n */\r\nexport function validateSaveSchema(data: unknown): SaveSchemaV1 {\r\n  assert(typeof data === 'object' && data !== null, 'Save data must be an object');\r\n  const save = data as unknown as Record<string, unknown>;\r\n  \r\n  assert(save.version === 1, 'Save version must be 1');\r\n  assert(typeof save.seed === 'number', 'Save seed must be a number');\r\n  assert(typeof save.tick === 'number' && save.tick >= 0, 'Save tick must be a non-negative number');\r\n  assert(typeof save.mapId === 'string', 'Save mapId must be a string');\r\n  \r\n  const playerPos = save.playerPos as Record<string, unknown>;\r\n  assert(typeof playerPos?.x === 'number', 'Save playerPos.x must be a number');\r\n  assert(typeof playerPos?.y === 'number', 'Save playerPos.y must be a number');\r\n  \r\n  assert(Array.isArray(save.inventory), 'Save inventory must be an array');\r\n  assert(typeof save.questFlags === 'object' && save.questFlags !== null, 'Save questFlags must be an object');\r\n  \r\n  return save as unknown as SaveSchemaV1;\r\n}\r\n\r\n/**\r\n * Migrate save from any version to current (v1).\r\n */\r\nexport function migrateSave(data: unknown): SaveSchemaV1 {\r\n  // For now, only v1 exists\r\n  return validateSaveSchema(data);\r\n}\r\n\r\n","/**\r\n * Movement system (handles player movement state).\r\n */\r\n\r\nimport type { GameState } from '../../types';\r\nimport type { SystemFn } from '../../types';\r\n\r\n/**\r\n * Movement system (currently a pass-through, can add animation/lerp here).\r\n */\r\nexport function movementSystem(state: GameState): GameState {\r\n  // Movement is handled by commands, this system can add interpolation later\r\n  return state;\r\n}\r\n\r\n","/**\r\n * Clock system - time and tick events.\r\n */\r\n\r\nimport type { GameState } from '../../types';\r\nimport type { SystemFn } from '../../types';\r\nimport { createClock } from '../state';\r\n\r\n/**\r\n * Clock system - updates time based on tick.\r\n */\r\nexport function clockSystem(state: GameState): GameState {\r\n  const time = state.tick * (16.6667 / 1000); // Convert ticks to seconds\r\n  return {\r\n    ...state,\r\n    clock: createClock(time),\r\n  };\r\n}\r\n\r\n","/**\r\n * Interaction system - adjacency checks and triggers.\r\n */\r\n\r\nimport type { GameState, Entity, EntityId } from '../../types';\r\nimport type { SystemFn } from '../../types';\r\nimport { getPlayer } from '../state';\r\nimport { isAdjacent } from '../map';\r\n\r\n/**\r\n * Interaction system - checks for adjacent interactables.\r\n */\r\nexport function interactionSystem(state: GameState): GameState {\r\n  // Interactions are triggered by commands, not systems\r\n  // This system can add visual feedback or auto-interaction logic\r\n  return state;\r\n}\r\n\r\n/**\r\n * Find entities adjacent to a position.\r\n */\r\nexport function findAdjacentEntities(\r\n  state: GameState,\r\n  position: { x: number; y: number },\r\n  excludeId?: EntityId\r\n): readonly Entity[] {\r\n  return state.entities.filter(\r\n    e => e.id !== excludeId && isAdjacent(e.position, position)\r\n  );\r\n}\r\n\r\n/**\r\n * Find the closest interactable entity to a position.\r\n */\r\nexport function findClosestInteractable(\r\n  state: GameState,\r\n  position: { x: number; y: number }\r\n): Entity | null {\r\n  const interactables = state.entities.filter(\r\n    e => e.tag === 'NPC' || e.tag === 'Chest' || e.tag === 'Door' || e.tag === 'Portal'\r\n  );\r\n  \r\n  if (interactables.length === 0) return null;\r\n  \r\n  let closest: Entity | null = null;\r\n  let minDist = Infinity;\r\n  \r\n  for (const entity of interactables) {\r\n    const dist = Math.abs(entity.position.x - position.x) + Math.abs(entity.position.y - position.y);\r\n    if (dist < minDist && dist <= 1) {\r\n      minDist = dist;\r\n      closest = entity;\r\n    }\r\n  }\r\n  \r\n  return closest;\r\n}\r\n\r\n","/**\r\n * Inventory system - item management.\r\n */\r\n\r\nimport type { GameState, ItemStack, Inventory } from '../../types';\r\nimport type { SystemFn } from '../../types';\r\nimport { getPlayer, updateEntity } from '../state';\r\n\r\n/**\r\n * Inventory system (pass-through for now).\r\n */\r\nexport function inventorySystem(state: GameState): GameState {\r\n  return state;\r\n}\r\n\r\n/**\r\n * Add item to player inventory.\r\n */\r\nexport function addItem(\r\n  state: GameState,\r\n  itemId: string,\r\n  count: number\r\n): GameState {\r\n  const player = getPlayer(state);\r\n  const items = [...player.inventory.items];\r\n  const existing = items.findIndex(i => i.itemId === itemId);\r\n  \r\n  if (existing >= 0) {\r\n    items[existing] = { ...items[existing], count: items[existing].count + count };\r\n  } else {\r\n    items.push({ itemId, count });\r\n  }\r\n  \r\n  return updateEntity(state, player.id, (e) => ({\r\n    ...e,\r\n    inventory: { items },\r\n  }));\r\n}\r\n\r\n/**\r\n * Remove item from player inventory.\r\n */\r\nexport function removeItem(\r\n  state: GameState,\r\n  itemId: string,\r\n  count: number\r\n): GameState {\r\n  const player = getPlayer(state);\r\n  const items = [...player.inventory.items];\r\n  const existing = items.findIndex(i => i.itemId === itemId);\r\n  \r\n  if (existing >= 0) {\r\n    const newCount = items[existing].count - count;\r\n    if (newCount <= 0) {\r\n      items.splice(existing, 1);\r\n    } else {\r\n      items[existing] = { ...items[existing], count: newCount };\r\n    }\r\n  }\r\n  \r\n  return updateEntity(state, player.id, (e) => ({\r\n    ...e,\r\n    inventory: { items },\r\n  }));\r\n}\r\n\r\n/**\r\n * Check if player has item.\r\n */\r\nexport function hasItem(state: GameState, itemId: string, count: number = 1): boolean {\r\n  const player = getPlayer(state);\r\n  const stack = player.inventory.items.find(i => i.itemId === itemId);\r\n  return stack !== undefined && stack.count >= count;\r\n}\r\n\r\n","/**\r\n * Chest system - open chests and give loot.\r\n */\r\n\r\nimport type { GameState, ChestEntity } from '../../types';\r\nimport type { SystemFn } from '../../types';\r\nimport { updateEntity } from '../state';\r\nimport { addItem } from './inventory';\r\n\r\n/**\r\n * Chest system (pass-through).\r\n */\r\nexport function chestSystem(state: GameState): GameState {\r\n  return state;\r\n}\r\n\r\n/**\r\n * Open a chest and give loot to player.\r\n */\r\nexport function openChest(state: GameState, chestId: string): GameState {\r\n  const chest = state.entities.find(\r\n    e => e.tag === 'Chest' && (e as ChestEntity).chestId === chestId\r\n  ) as ChestEntity | undefined;\r\n  \r\n  if (!chest || chest.opened) return state;\r\n  \r\n  let next = updateEntity(state, chest.id, (e) => {\r\n    const c = e as ChestEntity;\r\n    return {\r\n      ...c,\r\n      opened: true,\r\n      metadata: { ...(c.metadata || {}), opened: true },\r\n    };\r\n  });\r\n  \r\n  // Give loot\r\n  for (const stack of chest.loot) {\r\n    next = addItem(next, stack.itemId, stack.count);\r\n  }\r\n  \r\n  return next;\r\n}\r\n\r\n","/**\r\n * Door system - lock/unlock, open/close.\r\n */\r\n\r\nimport type { GameState, DoorEntity } from '../../types';\r\nimport type { SystemFn } from '../../types';\r\nimport { updateEntity } from '../state';\r\nimport { hasItem } from './inventory';\r\n\r\n/**\r\n * Door system (pass-through).\r\n */\r\nexport function doorSystem(state: GameState): GameState {\r\n  return state;\r\n}\r\n\r\n/**\r\n * Try to open a door (requires key if locked).\r\n */\r\nexport function openDoor(state: GameState, doorId: string): GameState {\r\n  const door = state.entities.find(e => e.tag === 'Door' && (e as DoorEntity).doorId === doorId) as DoorEntity | undefined;\r\n  if (!door) return state;\r\n  \r\n  if (door.locked) {\r\n    if (door.keyId && !hasItem(state, door.keyId)) {\r\n      return state; // Can't open without key\r\n    }\r\n    // Unlock and open\r\n    return updateEntity(state, door.id, (e) => ({\r\n      ...e,\r\n      solid: false,\r\n      metadata: { ...(e.metadata || {}), locked: false },\r\n    }));\r\n  }\r\n  \r\n  // Just open\r\n  return updateEntity(state, door.id, (e) => ({\r\n    ...e,\r\n    solid: false,\r\n  }));\r\n}\r\n\r\n","/**\r\n * Plugin registry - ðŸ”Œ PLUGIN POINT for systems, commands, and triggers.\r\n * \r\n * This module provides the extension mechanism for AAGAMEADVENTURE.\r\n * Plugins call registerSystem(), registerCommand(), registerTrigger() to inject custom logic.\r\n * Registry maintains insertion order; systems run in the order they were registered.\r\n * Used by core engine and all mods (combat, shop, procedural, etc.).\r\n */\r\n\r\nimport type { Registry, SystemFn, CommandHandler, TriggerHandler } from '../types';\r\n\r\n/**\r\n * Create a new plugin registry.\r\n * \r\n * Returns a Registry with methods to register systems, commands, and triggers.\r\n * Systems are executed in registration order during step().\r\n */\r\nexport function createRegistry(): Registry {\r\n  const systems: Array<{ name: string; fn: SystemFn }> = [];\r\n  const commands = new Map<string, CommandHandler>();\r\n  const triggers = new Map<string, TriggerHandler>();\r\n  \r\n  return {\r\n    registerSystem(name: string, system: SystemFn): void {\r\n      systems.push({ name, fn: system });\r\n    },\r\n    registerCommand(type: string, handler: CommandHandler): void {\r\n      commands.set(type, handler);\r\n    },\r\n    registerTrigger(type: string, handler: TriggerHandler): void {\r\n      triggers.set(type, handler);\r\n    },\r\n    getSystems(): readonly SystemFn[] {\r\n      return systems.map(s => s.fn);\r\n    },\r\n    getCommand(type: string): CommandHandler | undefined {\r\n      return commands.get(type);\r\n    },\r\n    getTrigger(type: string): TriggerHandler | undefined {\r\n      return triggers.get(type);\r\n    },\r\n  };\r\n}\r\n\r\n","/**\r\n * Combat rules - minimal numbers and pure logic.\r\n */\r\n\r\nimport type { GameState } from '../../types';\r\n\r\nexport interface CombatResult {\r\n  damage: number;\r\n  hit: boolean;\r\n}\r\n\r\n/**\r\n * Calculate attack damage.\r\n */\r\nexport function calculateDamage(attackerPower: number, defenderDefense: number): CombatResult {\r\n  const baseDamage = attackerPower;\r\n  const mitigated = Math.max(1, baseDamage - defenderDefense);\r\n  const hit = Math.random() > 0.2; // 80% hit chance\r\n  \r\n  return {\r\n    damage: hit ? mitigated : 0,\r\n    hit,\r\n  };\r\n}\r\n\r\n/**\r\n * Handle attack command.\r\n */\r\nexport function handleAttack(state: GameState, enemyId: string): GameState {\r\n  // Minimal implementation - would update entity health\r\n  return state;\r\n}\r\n\r\n/**\r\n * Combat rules module.\r\n */\r\nexport const combatRules = {\r\n  calculateDamage,\r\n  handleAttack,\r\n};\r\n\r\n","/**\r\n * Combat plugin - turn-based combat system.\r\n * ðŸ”Œ PLUGIN POINT: Registers combat systems and UI hooks.\r\n */\r\n\r\nimport type { EnginePlugin, PluginCtx, Registry, GameState, RenderSnapshot, HUDComposer } from '../../types';\r\nimport { combatRules } from './rules';\r\n\r\nlet combatState: { inCombat: boolean; enemyId?: string } = { inCombat: false };\r\n\r\n/**\r\n * Combat plugin.\r\n */\r\nexport const combatPlugin: EnginePlugin = {\r\n  id: 'combat',\r\n  \r\n  init(ctx: PluginCtx): void {\r\n    // Initialize combat state\r\n    combatState = { inCombat: false };\r\n  },\r\n  \r\n  onRegister(reg: Registry): void {\r\n    // Register combat system\r\n    reg.registerSystem('combat', (state: GameState) => {\r\n      // Combat logic handled by rules\r\n      return state;\r\n    });\r\n    \r\n    // Register combat command\r\n    reg.registerCommand('Attack', (state, intent) => {\r\n      if (combatState.inCombat) {\r\n        return combatRules.handleAttack(state, combatState.enemyId!);\r\n      }\r\n      return state;\r\n    });\r\n  },\r\n  \r\n  onPreStep(s: GameState): GameState {\r\n    // Check for combat triggers\r\n    return s;\r\n  },\r\n  \r\n  onPostStep(s: GameState): GameState {\r\n    // Update combat state\r\n    return s;\r\n  },\r\n  \r\n  ui: {\r\n    hud(hud: HUDComposer, snap: RenderSnapshot): void {\r\n      if (combatState.inCombat) {\r\n        hud.addText(10, 60, 'COMBAT MODE', '#ff0000');\r\n      }\r\n    },\r\n  },\r\n};\r\n\r\n","/**\r\n * Shop plugin - buy/sell screen.\r\n * ðŸ”Œ PLUGIN POINT: Registers shop interaction triggers.\r\n */\r\n\r\nimport type { EnginePlugin, PluginCtx, Registry, GameState, RenderSnapshot, HUDComposer } from '../../types';\r\n\r\nlet shopState: { open: boolean; shopId?: string } = { open: false };\r\n\r\n/**\r\n * Shop plugin.\r\n */\r\nexport const shopPlugin: EnginePlugin = {\r\n  id: 'shop',\r\n  \r\n  init(ctx: PluginCtx): void {\r\n    shopState = { open: false };\r\n  },\r\n  \r\n  onRegister(reg: Registry): void {\r\n    // Register shop trigger\r\n    reg.registerTrigger('shop', (state, entity, actor) => {\r\n      if (entity.tag === 'NPC' && (entity as any).shopId) {\r\n        shopState.open = true;\r\n        shopState.shopId = (entity as any).shopId;\r\n      }\r\n      return state;\r\n    });\r\n    \r\n    // Register buy/sell commands\r\n    reg.registerCommand('Buy', (state, intent) => {\r\n      if (shopState.open && intent.type === 'UseItem') {\r\n        // Handle purchase\r\n      }\r\n      return state;\r\n    });\r\n  },\r\n  \r\n  ui: {\r\n    hud(hud: HUDComposer, snap: RenderSnapshot): void {\r\n      if (shopState.open) {\r\n        hud.addText(10, 80, 'SHOP OPEN - Press E to buy', '#00ff00');\r\n      }\r\n    },\r\n  },\r\n};\r\n\r\n","/**\r\n * Procedural Map Generation Plugin\r\n * ðŸ”Œ PLUGIN POINT: Generates maps procedurally using various algorithms\r\n */\r\n\r\nimport type { EnginePlugin, PluginCtx, Registry, GameState, Entity, EntityId } from '../../types';\r\nimport { createState } from '../../engine/state';\r\n\r\nexport interface ProceduralMapParams {\r\n  width: number;\r\n  height: number;\r\n  seed?: number;\r\n  difficulty?: number; // 0-10, affects entity density and types\r\n  biome?: 'dungeon' | 'cave' | 'forest' | 'ruins' | 'maze';\r\n  roomCount?: number; // For dungeon/ruins biomes\r\n  corridorChance?: number; // For maze biome\r\n}\r\n\r\nlet proceduralMaps: Map<string, GameState> = new Map();\r\n\r\n/**\r\n * Generate tiles using cellular automata (good for caves)\r\n */\r\nfunction generateCaveTiles(width: number, height: number, seed: number): number[] {\r\n  const tiles: number[] = [];\r\n  const rng = seededRandom(seed);\r\n  \r\n  // Initialize with random noise\r\n  for (let y = 0; y < height; y++) {\r\n    for (let x = 0; x < width; x++) {\r\n      const isEdge = x === 0 || y === 0 || x === width - 1 || y === height - 1;\r\n      tiles.push(isEdge ? 1 : rng() < 0.45 ? 1 : 0);\r\n    }\r\n  }\r\n  \r\n  // Apply cellular automata smoothing\r\n  for (let iter = 0; iter < 4; iter++) {\r\n    const newTiles = [...tiles];\r\n    for (let y = 1; y < height - 1; y++) {\r\n      for (let x = 1; x < width - 1; x++) {\r\n        let wallCount = 0;\r\n        for (let dy = -1; dy <= 1; dy++) {\r\n          for (let dx = -1; dx <= 1; dx++) {\r\n            if (tiles[(y + dy) * width + (x + dx)] === 1) wallCount++;\r\n          }\r\n        }\r\n        newTiles[y * width + x] = wallCount >= 5 ? 1 : 0;\r\n      }\r\n    }\r\n    tiles.splice(0, tiles.length, ...newTiles);\r\n  }\r\n  \r\n  return tiles;\r\n}\r\n\r\n/**\r\n * Generate dungeon with rooms and corridors\r\n */\r\nfunction generateDungeonTiles(width: number, height: number, seed: number, roomCount: number): number[] {\r\n  const tiles: number[] = [];\r\n  const rng = seededRandom(seed);\r\n  \r\n  // Initialize all walls\r\n  for (let y = 0; y < height; y++) {\r\n    for (let x = 0; x < width; x++) {\r\n      tiles.push(1);\r\n    }\r\n  }\r\n  \r\n  interface Room {\r\n    x: number;\r\n    y: number;\r\n    w: number;\r\n    h: number;\r\n  }\r\n  \r\n  const rooms: Room[] = [];\r\n  \r\n  // Generate rooms\r\n  for (let i = 0; i < roomCount; i++) {\r\n    const w = 4 + Math.floor(rng() * 6);\r\n    const h = 4 + Math.floor(rng() * 6);\r\n    const x = 2 + Math.floor(rng() * (width - w - 4));\r\n    const y = 2 + Math.floor(rng() * (height - h - 4));\r\n    \r\n    // Check overlap\r\n    let overlaps = false;\r\n    for (const room of rooms) {\r\n      if (x < room.x + room.w + 2 && x + w + 2 > room.x &&\r\n          y < room.y + room.h + 2 && y + h + 2 > room.y) {\r\n        overlaps = true;\r\n        break;\r\n      }\r\n    }\r\n    \r\n    if (!overlaps) {\r\n      rooms.push({ x, y, w, h });\r\n      // Carve room\r\n      for (let ry = y; ry < y + h; ry++) {\r\n        for (let rx = x; rx < x + w; rx++) {\r\n          tiles[ry * width + rx] = 0;\r\n        }\r\n      }\r\n    }\r\n  }\r\n  \r\n  // Connect rooms with corridors\r\n  for (let i = 1; i < rooms.length; i++) {\r\n    const prev = rooms[i - 1];\r\n    const curr = rooms[i];\r\n    \r\n    const px = Math.floor(prev.x + prev.w / 2);\r\n    const py = Math.floor(prev.y + prev.h / 2);\r\n    const cx = Math.floor(curr.x + curr.w / 2);\r\n    const cy = Math.floor(curr.y + curr.h / 2);\r\n    \r\n    // L-shaped corridor\r\n    for (let x = Math.min(px, cx); x <= Math.max(px, cx); x++) {\r\n      tiles[py * width + x] = 0;\r\n    }\r\n    for (let y = Math.min(py, cy); y <= Math.max(py, cy); y++) {\r\n      tiles[y * width + cx] = 0;\r\n    }\r\n  }\r\n  \r\n  return tiles;\r\n}\r\n\r\n/**\r\n * Generate maze using recursive backtracking\r\n */\r\nfunction generateMazeTiles(width: number, height: number, seed: number, corridorChance: number): number[] {\r\n  const tiles: number[] = [];\r\n  const rng = seededRandom(seed);\r\n  \r\n  // Initialize all walls\r\n  for (let y = 0; y < height; y++) {\r\n    for (let x = 0; x < width; x++) {\r\n      tiles.push(1);\r\n    }\r\n  }\r\n  \r\n  // Recursive backtracking maze generation\r\n  const visited: boolean[] = new Array(width * height).fill(false);\r\n  const stack: number[] = [];\r\n  \r\n  function getNeighbors(cell: number): number[] {\r\n    const x = cell % width;\r\n    const y = Math.floor(cell / width);\r\n    const neighbors: number[] = [];\r\n    \r\n    if (x > 1 && !visited[cell - 2]) neighbors.push(cell - 2);\r\n    if (x < width - 2 && !visited[cell + 2]) neighbors.push(cell + 2);\r\n    if (y > 1 && !visited[cell - width * 2]) neighbors.push(cell - width * 2);\r\n    if (y < height - 2 && !visited[cell + width * 2]) neighbors.push(cell + width * 2);\r\n    \r\n    return neighbors;\r\n  }\r\n  \r\n  // Start at (1, 1)\r\n  let current = width + 1;\r\n  visited[current] = true;\r\n  tiles[current] = 0;\r\n  stack.push(current);\r\n  \r\n  while (stack.length > 0) {\r\n    const neighbors = getNeighbors(current);\r\n    \r\n    if (neighbors.length > 0) {\r\n      const next = neighbors[Math.floor(rng() * neighbors.length)];\r\n      const wall = (current + next) / 2;\r\n      \r\n      visited[next] = true;\r\n      tiles[next] = 0;\r\n      tiles[wall] = 0;\r\n      \r\n      stack.push(next);\r\n      current = next;\r\n    } else {\r\n      current = stack.pop()!;\r\n    }\r\n  }\r\n  \r\n  // Add extra corridors for connectivity\r\n  for (let y = 2; y < height - 2; y += 2) {\r\n    for (let x = 2; x < width - 2; x += 2) {\r\n      if (rng() < corridorChance && tiles[y * width + x] === 1) {\r\n        tiles[y * width + x] = 0;\r\n      }\r\n    }\r\n  }\r\n  \r\n  return tiles;\r\n}\r\n\r\n/**\r\n * Generate entities based on difficulty and biome\r\n */\r\nfunction generateEntities(\r\n  tiles: number[],\r\n  width: number,\r\n  height: number,\r\n  seed: number,\r\n  difficulty: number,\r\n  biome: string\r\n): Entity[] {\r\n  const entities: Entity[] = [];\r\n  const rng = seededRandom(seed + 1000);\r\n  const floorTiles: number[] = [];\r\n  \r\n  // Find all floor tiles\r\n  for (let i = 0; i < tiles.length; i++) {\r\n    if (tiles[i] === 0) {\r\n      floorTiles.push(i);\r\n    }\r\n  }\r\n  \r\n  // Shuffle floor tiles\r\n  for (let i = floorTiles.length - 1; i > 0; i--) {\r\n    const j = Math.floor(rng() * (i + 1));\r\n    [floorTiles[i], floorTiles[j]] = [floorTiles[j], floorTiles[i]];\r\n  }\r\n  \r\n  const entityCount = Math.floor(floorTiles.length * (0.05 + difficulty * 0.02));\r\n  \r\n  // Place player at first floor tile\r\n  if (floorTiles.length > 0) {\r\n    const playerPos = floorTiles[0];\r\n    const px = playerPos % width;\r\n    const py = Math.floor(playerPos / width);\r\n    entities.push({\r\n      id: 'player' as EntityId,\r\n      tag: 'Player',\r\n      position: { x: px, y: py },\r\n      solid: true,\n    });\r\n  }\r\n  \r\n  // Place chests (10-20% of entity count)\r\n  const chestCount = Math.max(1, Math.floor(entityCount * (0.1 + rng() * 0.1)));\r\n  for (let i = 0; i < chestCount && i + 1 < floorTiles.length; i++) {\r\n    const pos = floorTiles[i + 1];\r\n    const x = pos % width;\r\n    const y = Math.floor(pos / width);\r\n    entities.push({\r\n      id: `chest_${i}` as EntityId,\r\n      tag: 'Chest',\r\n      position: { x, y },\r\n      solid: true,\r\n      metadata: {\r\n        chestId: `procedural_chest_${i}`,\r\n        opened: false,\r\n        loot: [{ itemId: 'gold', count: 10 + Math.floor(rng() * 50) }],\r\n      },\r\n    });\r\n  }\r\n  \r\n  // Place NPCs (5-10% of entity count)\r\n  const npcCount = Math.max(0, Math.floor(entityCount * (0.05 + rng() * 0.05)));\r\n  for (let i = 0; i < npcCount && i + chestCount + 1 < floorTiles.length; i++) {\r\n    const pos = floorTiles[i + chestCount + 1];\r\n    const x = pos % width;\r\n    const y = Math.floor(pos / width);\r\n    entities.push({\r\n      id: `npc_${i}` as EntityId,\r\n      tag: 'NPC',\r\n      position: { x, y },\r\n      solid: true,\r\n      metadata: {\r\n        npcId: `procedural_npc_${i}`,\r\n        dialogId: `procedural_dialog_${i}`,\r\n      },\r\n    });\r\n  }\r\n  \r\n  // Place doors (2-5% of entity count)\r\n  const doorCount = Math.max(0, Math.floor(entityCount * (0.02 + rng() * 0.03)));\r\n  for (let i = 0; i < doorCount && i + chestCount + npcCount + 1 < floorTiles.length; i++) {\r\n    const pos = floorTiles[i + chestCount + npcCount + 1];\r\n    const x = pos % width;\r\n    const y = Math.floor(pos / width);\r\n    entities.push({\r\n      id: `door_${i}` as EntityId,\r\n      tag: 'Door',\r\n      position: { x, y },\r\n      solid: true,\r\n      metadata: {\r\n        doorId: `procedural_door_${i}`,\r\n        locked: rng() < 0.3,\r\n        keyId: rng() < 0.5 ? `key_${i}` : undefined,\r\n      },\r\n    });\r\n  }\r\n  \r\n  return entities;\r\n}\r\n\r\n/**\r\n * Generate a procedural map\r\n */\r\nexport function generateProceduralMap(params: ProceduralMapParams): GameState {\r\n  const {\r\n    width = 32,\r\n    height = 18,\r\n    seed = Date.now(),\r\n    difficulty = 5,\r\n    biome = 'dungeon',\r\n    roomCount = 8,\r\n    corridorChance = 0.1,\r\n  } = params;\r\n  \r\n  let tiles: number[] = [];\r\n  \r\n  switch (biome) {\r\n    case 'cave':\r\n      tiles = generateCaveTiles(width, height, seed);\r\n      break;\r\n    case 'maze':\r\n      tiles = generateMazeTiles(width, height, seed, corridorChance);\r\n      break;\r\n    case 'dungeon':\r\n    case 'ruins':\r\n      tiles = generateDungeonTiles(width, height, seed, roomCount);\r\n      break;\r\n    case 'forest':\r\n      // Forest uses simpler random generation\r\n      const rng = seededRandom(seed);\r\n      for (let y = 0; y < height; y++) {\r\n        for (let x = 0; x < width; x++) {\r\n          const isEdge = x === 0 || y === 0 || x === width - 1 || y === height - 1;\r\n          tiles.push(isEdge ? 1 : rng() < 0.2 ? 1 : 0);\r\n        }\r\n      }\r\n      break;\r\n    default:\r\n      tiles = generateDungeonTiles(width, height, seed, roomCount);\r\n  }\r\n  \r\n  const entities = generateEntities(tiles, width, height, seed, difficulty, biome);\r\n  const playerEntity = entities.find(e => e.id === 'player');\r\n  const playerStart = playerEntity?.position || { x: 1, y: 1 };\r\n  \r\n  return createState({\r\n    version: 1,\r\n    seed,\r\n    mapId: `procedural_${biome}_${seed}`,\r\n    mapWidth: width,\r\n    mapHeight: height,\r\n    tiles,\r\n    entities,\r\n    playerId: 'player' as EntityId,\r\n  });\r\n}\r\n\r\n/**\r\n * Seeded random number generator\r\n */\r\nfunction seededRandom(seed: number): () => number {\r\n  let value = seed;\r\n  return () => {\r\n    value = (value * 9301 + 49297) % 233280;\r\n    return value / 233280;\r\n  };\r\n}\r\n\r\n/**\r\n * Procedural map generation plugin\r\n */\r\nexport const proceduralMapPlugin: EnginePlugin = {\r\n  id: 'procedural-map',\r\n  \r\n  init(ctx: PluginCtx): void {\r\n    proceduralMaps.clear();\r\n  },\r\n  \r\n  onRegister(reg: Registry): void {\r\n    // Register command to generate procedural map\r\n    reg.registerCommand('GenerateProceduralMap', (state, intent) => {\r\n      if ((intent as any).type === 'GenerateProceduralMap') {\r\n        const params = (intent as any).params as ProceduralMapParams;\r\n        const newState = generateProceduralMap(params);\r\n        proceduralMaps.set(newState.mapId, newState);\r\n        return newState;\r\n      }\r\n      return state;\r\n    });\r\n    \r\n    // Register system to periodically generate new areas\r\n    reg.registerSystem('procedural-map-generator', (state) => {\r\n      // Could auto-generate adjacent areas when player reaches map edges\r\n      return state;\r\n    });\r\n  },\r\n  \r\n  onPreStep(state: GameState): GameState {\r\n    // Check if we should generate a new map\r\n    // This could be triggered by portals or map boundaries\r\n    return state;\r\n  },\r\n};\r\n\r\n","/**\r\n * Playtest utilities - helpers for common debugging tasks.\r\n * Provides: teleport, entity spawning, state modification, replay capture.\r\n */\r\n\r\nimport type { GameState, Entity, EntityId, Position } from '../types';\r\nimport { getPlayer, updateEntity, updateEntities, setQuestFlag } from '../engine/state';\r\nimport { assertDefined } from '../utils/assert';\r\n\r\n/**\r\n * Replay capture for debugging - records intents and state snapshots.\r\n */\r\nexport interface PlaytestReplay {\r\n  seed: number;\r\n  initialState: GameState;\r\n  intents: Array<{ tick: number; intent: any }>;\r\n  snapshots: Array<{ tick: number; state: GameState }>;\r\n}\r\n\r\nlet currentReplay: PlaytestReplay | null = null;\r\n\r\n/**\r\n * Start recording a replay.\r\n */\r\nexport function startReplay(state: GameState): void {\r\n  currentReplay = {\r\n    seed: state.seed,\r\n    initialState: JSON.parse(JSON.stringify(state)),\r\n    intents: [],\r\n    snapshots: [{ tick: 0, state: JSON.parse(JSON.stringify(state)) }],\r\n  };\r\n}\r\n\r\n/**\r\n * Record an intent in the current replay.\r\n */\r\nexport function recordIntent(state: GameState, intent: any): void {\r\n  if (!currentReplay) return;\r\n  currentReplay.intents.push({ tick: state.tick, intent });\r\n  if (state.tick % 60 === 0) {\r\n    // Snapshot every 60 ticks to reduce memory\r\n    currentReplay.snapshots.push({ tick: state.tick, state: JSON.parse(JSON.stringify(state)) });\r\n  }\r\n}\r\n\r\n/**\r\n * Export current replay to JSON for sharing/debugging.\r\n */\r\nexport function exportReplay(): string {\r\n  if (!currentReplay) return 'No replay recorded';\r\n  return JSON.stringify(currentReplay, null, 2);\r\n}\r\n\r\n/**\r\n * Copy replay to clipboard.\r\n */\r\nexport function copyReplayToClipboard(): void {\r\n  const json = exportReplay();\r\n  navigator.clipboard.writeText(json).then(() => {\r\n    console.log('Replay copied to clipboard');\r\n  });\r\n}\r\n\r\n/**\r\n * Teleport player to position.\r\n */\r\nexport function teleportPlayer(state: GameState, x: number, y: number): GameState {\r\n  const player = getPlayer(state);\r\n  return updateEntity(state, player.id, (p) => ({\r\n    ...p,\r\n    position: { x, y },\r\n  }));\r\n}\r\n\r\n/**\r\n * Teleport player to tile on click (for playtesting).\r\n * Returns a function to call on canvas click.\r\n */\r\nexport function createTeleportTool(\r\n  state: GameState,\r\n  canvasElement: HTMLCanvasElement,\r\n  onTeleport: (newState: GameState) => void\r\n): { enable: () => void; disable: () => void } {\r\n  let enabled = false;\r\n  const tileSize = 32;\r\n\r\n  function handleClick(e: MouseEvent): void {\r\n    if (!enabled) return;\r\n    const rect = canvasElement.getBoundingClientRect();\r\n    const x = Math.floor((e.clientX - rect.left) / tileSize);\r\n    const y = Math.floor((e.clientY - rect.top) / tileSize);\r\n    const newState = teleportPlayer(state, x, y);\r\n    onTeleport(newState);\r\n  }\r\n\r\n  return {\r\n    enable: () => {\r\n      enabled = true;\r\n      canvasElement.style.cursor = 'crosshair';\r\n      canvasElement.addEventListener('click', handleClick);\r\n      console.log('Teleport tool enabled - click to teleport');\r\n    },\r\n    disable: () => {\r\n      enabled = false;\r\n      canvasElement.style.cursor = 'default';\r\n      canvasElement.removeEventListener('click', handleClick);\r\n      console.log('Teleport tool disabled');\r\n    },\r\n  };\r\n}\r\n\r\n/**\r\n * Spawn an entity at position.\r\n */\r\nexport function spawnEntity(state: GameState, entity: Entity): GameState {\r\n  return updateEntities(state, [...state.entities, entity]);\r\n}\r\n\r\n/**\r\n * Despawn entity by ID.\r\n */\r\nexport function despawnEntity(state: GameState, entityId: EntityId): GameState {\r\n  return updateEntities(state, state.entities.filter((e) => e.id !== entityId));\r\n}\r\n\r\n/**\r\n * Set all quest flags to complete for testing.\r\n */\r\nexport function completeAllQuests(state: GameState): GameState {\r\n  let result = state;\r\n  for (const key of Object.keys(state.questFlags)) {\r\n    result = setQuestFlag(result, key, true);\r\n  }\r\n  return result;\r\n}\r\n\r\n/**\r\n * Reset quest flags.\r\n */\r\nexport function resetQuests(state: GameState): GameState {\r\n  return { ...state, questFlags: {} };\r\n}\r\n\r\n/**\r\n * Modify player inventory for testing.\r\n */\r\nexport function setPlayerInventory(state: GameState, items: Array<{ itemId: string; count: number }>): GameState {\r\n  const player = getPlayer(state);\r\n  return updateEntity(state, player.id, (p) => ({\r\n    ...p,\r\n    inventory: { items },\r\n  }));\r\n}\r\n\r\n/**\r\n * Add item to player inventory.\r\n */\r\nexport function addItemToInventory(\r\n  state: GameState,\r\n  itemId: string,\r\n  count: number = 1\r\n): GameState {\r\n  const player = getPlayer(state);\r\n  const items = [...player.inventory.items];\r\n  const idx = items.findIndex((s) => s.itemId === itemId);\r\n  if (idx >= 0) {\r\n    items[idx] = { ...items[idx], count: items[idx].count + count };\r\n  } else {\r\n    items.push({ itemId, count });\r\n  }\r\n  return updateEntity(state, player.id, (p) => ({\r\n    ...p,\r\n    inventory: { items },\r\n  }));\r\n}\r\n\r\n/**\r\n * Debug console with common playtest commands.\r\n * Usage: window.playtest.teleport(5, 5), etc.\r\n */\r\nexport function createPlaytestConsole(\r\n  onCommand: (cmd: string, args: any[]) => GameState\r\n): void {\r\n  (window as any).playtest = {\r\n    teleport: (x: number, y: number) => {\r\n      console.log(`Teleporting to (${x}, ${y})`);\r\n      return onCommand('teleport', [x, y]);\r\n    },\r\n    spawn: (tag: string, x: number, y: number, id?: string) => {\r\n      console.log(`Spawning ${tag} at (${x}, ${y})`);\r\n      return onCommand('spawn', [tag, x, y, id]);\r\n    },\r\n    despawn: (entityId: string) => {\r\n      console.log(`Despawning ${entityId}`);\r\n      return onCommand('despawn', [entityId]);\r\n    },\r\n    addItem: (itemId: string, count?: number) => {\r\n      console.log(`Adding ${count || 1}x ${itemId}`);\r\n      return onCommand('addItem', [itemId, count || 1]);\r\n    },\r\n    setQuest: (questId: string, value: boolean) => {\r\n      console.log(`Setting quest ${questId} = ${value}`);\r\n      return onCommand('setQuest', [questId, value]);\r\n    },\r\n    completeAllQuests: () => {\r\n      console.log('Completing all quests');\r\n      return onCommand('completeAllQuests', []);\r\n    },\r\n    exportReplay: () => {\r\n      const json = exportReplay();\r\n      console.log(json);\r\n      return json;\r\n    },\r\n    copyReplay: () => copyReplayToClipboard(),\r\n    help: () => {\r\n      console.log(`\r\nPlaytest Console Commands:\r\n  playtest.teleport(x, y)\r\n  playtest.spawn(tag, x, y, [id])\r\n  playtest.despawn(entityId)\r\n  playtest.addItem(itemId, [count])\r\n  playtest.setQuest(questId, value)\r\n  playtest.completeAllQuests()\r\n  playtest.exportReplay()\r\n  playtest.copyReplay()\r\n      `);\r\n    },\r\n  };\r\n\r\n  console.log('Playtest console ready! Type: playtest.help()');\r\n}\r\n","/**\r\n * Playtest menu UI - in-game controls for debugging and testing.\r\n * Accessible via debug console or F2 (if enabled).\r\n */\r\n\r\nimport type { GameState } from '../types';\r\n\r\nexport interface PlaytestMenu {\r\n  show: () => void;\r\n  hide: () => void;\r\n  update: (state: GameState) => void;\r\n  destroy: () => void;\r\n}\r\n\r\nlet menuEl: HTMLDivElement | null = null;\r\nlet menuVisible = false;\r\nlet currentState: GameState | null = null;\r\nlet onCommand: ((cmd: string, args: any[]) => void) | null = null;\r\n\r\n/**\r\n * Create playtest menu UI.\r\n */\r\nexport function createPlaytestMenu(\r\n  onCommandFn: (cmd: string, args: any[]) => void\r\n): PlaytestMenu {\r\n  onCommand = onCommandFn;\r\n\r\n  if (!menuEl) {\r\n    menuEl = document.createElement('div');\r\n    menuEl.id = 'playtest-menu';\r\n    menuEl.style.cssText = `\r\n      position: fixed;\r\n      top: 50%;\r\n      left: 50%;\r\n      transform: translate(-50%, -50%);\r\n      background: rgba(0, 0, 0, 0.95);\r\n      border: 2px solid #00ff00;\r\n      color: #00ff00;\r\n      padding: 20px;\r\n      font-family: monospace;\r\n      font-size: 14px;\r\n      z-index: 9998;\r\n      display: none;\r\n      max-height: 80vh;\r\n      overflow-y: auto;\r\n      min-width: 400px;\r\n      box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);\r\n    `;\r\n    menuEl.innerHTML = `\r\n      <div style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #00ff00; padding-bottom: 10px;\">\r\n        <h2 style=\"margin: 0;\">PLAYTEST MENU</h2>\r\n        <button id=\"close-menu\" style=\"background: #00ff00; color: #000; border: none; padding: 5px 10px; cursor: pointer; font-family: monospace;\">X</button>\r\n      </div>\r\n      <div id=\"menu-content\"></div>\r\n      <div style=\"margin-top: 15px; border-top: 1px solid #00ff00; padding-top: 10px; font-size: 12px; color: #88ff88;\">\r\n        <p>Press ESC to close | Console: playtest.help()</p>\r\n      </div>\r\n    `;\r\n    document.body.appendChild(menuEl);\r\n\r\n    // Close button\r\n    menuEl.querySelector('#close-menu')?.addEventListener('click', () => {\r\n      hide();\r\n    });\r\n\r\n    // ESC to close\r\n    window.addEventListener('keydown', (e) => {\r\n      if (e.code === 'Escape' && menuVisible) {\r\n        hide();\r\n      }\r\n    });\r\n  }\r\n\r\n  function renderMenu(): void {\r\n    if (!menuEl || !currentState) return;\r\n\r\n    const content = menuEl.querySelector('#menu-content') as HTMLDivElement;\r\n    if (!content) return;\r\n\r\n    const player = currentState.entities.find((e) => e.id === currentState!.playerId);\r\n    const playerPos = player?.position || { x: 0, y: 0 };\r\n\r\n    content.innerHTML = `\r\n      <div style=\"margin-bottom: 15px;\">\r\n        <h3 style=\"margin: 0 0 10px 0;\">Game State</h3>\r\n        <p style=\"margin: 5px 0;\"><strong>Seed:</strong> ${currentState.seed}</p>\r\n        <p style=\"margin: 5px 0;\"><strong>Map:</strong> ${currentState.mapId}</p>\r\n        <p style=\"margin: 5px 0;\"><strong>Tick:</strong> ${currentState.tick}</p>\r\n        <p style=\"margin: 5px 0;\"><strong>Player Position:</strong> (${playerPos.x}, ${playerPos.y})</p>\r\n        <p style=\"margin: 5px 0;\"><strong>Entities:</strong> ${currentState.entities.length}</p>\r\n        <p style=\"margin: 5px 0;\"><strong>Clock:</strong> Day ${currentState.clock.day} ${currentState.clock.hour}:${String(currentState.clock.minute).padStart(2, '0')}</p>\r\n      </div>\r\n\r\n      <div style=\"margin-bottom: 15px;\">\r\n        <h3 style=\"margin: 0 0 10px 0;\">Movement</h3>\r\n        <div style=\"display: grid; grid-template-columns: 1fr 1fr; gap: 5px;\">\r\n          <button class=\"menu-btn\" data-cmd=\"teleport\" data-args=\"0,0\">Teleport to (0,0)</button>\r\n          <button class=\"menu-btn\" data-cmd=\"teleport\" data-args=\"16,9\">Center</button>\r\n          <button class=\"menu-btn\" data-cmd=\"teleport\" data-args=\"${currentState.mapWidth - 2},${currentState.mapHeight - 2}\">Bottom-Right</button>\r\n          <button class=\"menu-btn\" data-cmd=\"teleport\" data-args=\"1,1\">Top-Left</button>\r\n        </div>\r\n      </div>\r\n\r\n      <div style=\"margin-bottom: 15px;\">\r\n        <h3 style=\"margin: 0 0 10px 0;\">Inventory</h3>\r\n        <div style=\"display: grid; grid-template-columns: 1fr 1fr; gap: 5px;\">\r\n          <button class=\"menu-btn\" data-cmd=\"addItem\" data-args=\"sword,1\">Add Sword</button>\r\n          <button class=\"menu-btn\" data-cmd=\"addItem\" data-args=\"shield,1\">Add Shield</button>\r\n          <button class=\"menu-btn\" data-cmd=\"addItem\" data-args=\"key,5\">Add Keys (5)</button>\r\n          <button class=\"menu-btn\" data-cmd=\"addItem\" data-args=\"potion,10\">Add Potions (10)</button>\r\n        </div>\r\n      </div>\r\n\r\n      <div style=\"margin-bottom: 15px;\">\r\n        <h3 style=\"margin: 0 0 10px 0;\">Quests</h3>\r\n        <div style=\"display: grid; grid-template-columns: 1fr 1fr; gap: 5px;\">\r\n          <button class=\"menu-btn\" data-cmd=\"completeAllQuests\">Complete All Quests</button>\r\n          <button class=\"menu-btn\" data-cmd=\"resetQuests\">Reset Quests</button>\r\n        </div>\r\n      </div>\r\n\r\n      <div style=\"margin-bottom: 15px;\">\r\n        <h3 style=\"margin: 0 0 10px 0;\">Replay</h3>\r\n        <div style=\"display: grid; grid-template-columns: 1fr 1fr; gap: 5px;\">\r\n          <button class=\"menu-btn\" data-cmd=\"startReplay\">Start Replay</button>\r\n          <button class=\"menu-btn\" data-cmd=\"copyReplay\">Copy Replay</button>\r\n        </div>\r\n      </div>\r\n\r\n      <div style=\"margin-bottom: 15px;\">\r\n        <h3 style=\"margin: 0 0 10px 0;\">Quests Status</h3>\r\n        ${\r\n          Object.entries(currentState.questFlags).length === 0\r\n            ? '<p style=\"color: #88ff88; font-size: 12px;\">No quests active</p>'\r\n            : Object.entries(currentState.questFlags)\r\n                .map(\r\n                  ([k, v]) =>\r\n                    `<p style=\"margin: 3px 0; font-size: 12px;\"><strong>${k}:</strong> ${v ? 'âœ“' : 'âœ—'}</p>`\r\n                )\r\n                .join('')\r\n        }\r\n      </div>\r\n    `;\r\n\r\n    // Attach click handlers\r\n    content.querySelectorAll('.menu-btn').forEach((btn) => {\r\n      btn.addEventListener('click', () => {\r\n        const cmd = (btn as HTMLButtonElement).dataset.cmd;\r\n        const argsStr = (btn as HTMLButtonElement).dataset.args || '';\r\n        const args = argsStr.split(',').map((a) => {\r\n          const num = parseInt(a, 10);\r\n          return isNaN(num) ? a : num;\r\n        });\r\n        if (cmd && onCommand) {\r\n          onCommand(cmd, args);\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  function show(): void {\r\n    menuVisible = true;\r\n    if (menuEl) {\r\n      menuEl.style.display = 'block';\r\n      renderMenu();\r\n    }\r\n  }\r\n\r\n  function hide(): void {\r\n    menuVisible = false;\r\n    if (menuEl) {\r\n      menuEl.style.display = 'none';\r\n    }\r\n  }\r\n\r\n  function update(state: GameState): void {\r\n    currentState = state;\r\n    if (menuVisible) {\r\n      renderMenu();\r\n    }\r\n  }\r\n\r\n  function destroy(): void {\r\n    if (menuEl) {\r\n      menuEl.remove();\r\n      menuEl = null;\r\n    }\r\n  }\r\n\r\n  return { show, hide, update, destroy };\r\n}\r\n\r\n/**\r\n * Bind F2 key to toggle playtest menu (if enabled).\r\n */\r\nexport function bindPlaytestMenuKey(menu: PlaytestMenu): void {\r\n  window.addEventListener('keydown', (e) => {\r\n    if (e.code === 'F2') {\r\n      e.preventDefault();\r\n      // Toggle: if not visible, show; if visible, hide\r\n      const el = document.getElementById('playtest-menu');\r\n      if (el?.style.display === 'block') {\r\n        menu.hide();\r\n      } else {\r\n        menu.show();\r\n      }\r\n    }\r\n  });\r\n}\r\n","const AI_SERVER_URL = (window as any).__AI_SERVER_URL__ || 'http://localhost:4873/ai';\r\n\r\nexport function initAIConsole() {\r\n  if (typeof document === 'undefined') return;\r\n\r\n  const root = document.createElement('div');\r\n  root.id = 'ai-console-root';\r\n  root.style.position = 'fixed';\r\n  root.style.right = '16px';\r\n  root.style.bottom = '16px';\r\n  root.style.width = '380px';\r\n  root.style.maxHeight = '60vh';\r\n  root.style.background = 'rgba(0,0,0,0.9)';\r\n  root.style.color = '#eee';\r\n  root.style.borderRadius = '8px';\r\n  root.style.padding = '8px';\r\n  root.style.fontFamily = 'system-ui, sans-serif';\r\n  root.style.fontSize = '12px';\r\n  root.style.display = 'none';\r\n  root.style.zIndex = '99999';\r\n\r\n  root.innerHTML = `\r\n    <div style=\"display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;\">\r\n      <strong>AI Assistant</strong>\r\n      <button id=\"ai-console-close\" style=\"background:none;border:none;color:#ccc;cursor:pointer;\">âœ•</button>\r\n    </div>\r\n    <label style=\"display:block;margin-bottom:6px;\">\r\n      <div>Instruction:</div>\r\n      <textarea id=\"ai-console-input\" style=\"width:100%;height:80px;background:#111;color:#eee;border:1px solid #444;border-radius:4px;padding:4px;\"></textarea>\r\n    </label>\r\n    <label style=\"display:block;margin-bottom:6px;\">\r\n      <div>Target paths (comma-separated, optional):</div>\r\n      <input id=\"ai-console-targets\" style=\"width:100%;background:#111;color:#eee;border:1px solid #444;border-radius:4px;padding:4px;\" />\r\n    </label>\r\n    <button id=\"ai-console-send\" style=\"width:100%;padding:6px 0;margin-bottom:6px;border-radius:4px;border:none;background:#2f855a;color:#fff;cursor:pointer;\">Ask AI</button>\r\n    <div id=\"ai-console-status\" style=\"font-size:11px;margin-bottom:6px;color:#aaa;\"></div>\r\n    <pre id=\"ai-console-output\" style=\"white-space:pre-wrap;background:#000;padding:6px;border-radius:4px;max-height:220px;overflow:auto;color:#ddd;\"></pre>\r\n  `;\r\n\r\n  document.body.appendChild(root);\r\n\r\n  const input = root.querySelector<HTMLTextAreaElement>('#ai-console-input')!;\r\n  const targetsInput = root.querySelector<HTMLInputElement>('#ai-console-targets')!;\r\n  const sendBtn = root.querySelector<HTMLButtonElement>('#ai-console-send')!;\r\n  const statusEl = root.querySelector<HTMLDivElement>('#ai-console-status')!;\r\n  const outputEl = root.querySelector<HTMLPreElement>('#ai-console-output')!;\r\n  const closeBtn = root.querySelector<HTMLButtonElement>('#ai-console-close')!;\r\n\r\n  sendBtn.onclick = async () => {\r\n    const instruction = input.value.trim();\r\n    const targetPaths = targetsInput.value.split(',').map(s => s.trim()).filter(Boolean);\r\n    if (!instruction) { statusEl.textContent = 'Please enter an instruction.'; return; }\r\n    statusEl.textContent = 'Sending to AIâ€¦';\r\n    outputEl.textContent = '';\r\n    try {\r\n      const res = await fetch(AI_SERVER_URL, {\r\n        method: 'POST', headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ instruction, targetPaths })\r\n      });\r\n      const json = await res.json();\r\n      if (!res.ok) { statusEl.textContent = 'Error from AI server.'; outputEl.textContent = JSON.stringify(json, null, 2); return; }\r\n      statusEl.textContent = 'Response received.';\r\n      const { suggestionsMarkdown, files } = json;\r\n      let text = `### Suggestions\\n\\n${suggestionsMarkdown || ''}\\n\\n### Files\\n\\n`;\r\n      for (const f of files || []) { text += `--- ${f.path} ---\\n${f.content}\\n\\n`; }\r\n      outputEl.textContent = text;\r\n    } catch (err) {\r\n      statusEl.textContent = 'Request failed.';\r\n      outputEl.textContent = String((err as any)?.message || err);\r\n    }\r\n  };\r\n\r\n  closeBtn.onclick = () => { root.style.display = 'none'; };\r\n\r\n  window.addEventListener('keydown', (ev) => {\r\n    if (ev.key === 'F3') { ev.preventDefault(); root.style.display = root.style.display === 'none' ? 'block' : 'none'; }\r\n  });\r\n}\r\n","/**\r\n * Main entry point - ðŸ”Œ PLUGIN POINT: loads plugins from config.\r\n */\r\n\r\nimport { config } from './config';\r\nimport { createCanvas } from './adapters/canvas';\r\nimport { createInput } from './adapters/input';\r\nimport { createGameLoop } from './adapters/loop';\r\nimport { draw } from './adapters/renderer/draw';\r\nimport { drawHUD } from './adapters/renderer/hud';\r\nimport { createDevOverlay } from './dev/overlay';\r\nimport { initDebugHUD } from './adapters/dev/debugHUD';\r\nimport { createState } from './engine/state';\r\nimport { step } from './engine/step';\r\nimport { assertInvariants } from './engine/state';\r\nimport { validateMapSchema, validateMapContent } from './engine/schema';\r\nimport { movementSystem } from './engine/systems/movement';\r\nimport { clockSystem } from './engine/systems/clock';\r\nimport { interactionSystem, findClosestInteractable } from './engine/systems/interaction';\r\nimport { openChest } from './engine/systems/chest';\r\nimport { openDoor } from './engine/systems/door';\r\nimport { setQuestFlag } from './engine/state';\r\nimport { createRegistry } from './engine/registry';\r\nimport type { GameState, Intent, RenderSnapshot, Entity, EntityId } from './types';\r\nimport { handleInteract } from './engine/commands';\r\nimport { combatPlugin } from './mods/combat';\r\nimport { shopPlugin } from './mods/shop';\r\nimport { proceduralMapPlugin } from './mods/procedural';\r\nimport {\r\n  createPlaytestConsole,\r\n  startReplay,\r\n  recordIntent,\r\n  teleportPlayer,\r\n  spawnEntity,\r\n  despawnEntity,\r\n  addItemToInventory,\r\n  completeAllQuests,\r\n  resetQuests,\r\n  copyReplayToClipboard,\r\n} from './dev/playtest';\r\nimport { createPlaytestMenu, bindPlaytestMenuKey } from './dev/menu';\r\nimport { initAIConsole } from './adapters/dev/aiConsole';\r\n\r\n// Error handling\r\nconst errorOverlay = document.getElementById('error-overlay');\r\nfunction showError(error: Error): void {\r\n  if (errorOverlay) {\r\n    errorOverlay.classList.remove('hidden');\r\n    errorOverlay.innerHTML = `\r\n      <h2>Error</h2>\r\n      <p>${error.message}</p>\r\n      <pre>${error.stack || 'No stack trace'}</pre>\r\n    `;\r\n  }\r\n  console.error(error);\r\n}\r\n\r\nwindow.addEventListener('error', (e) => {\r\n  showError(e.error);\r\n});\r\n\r\nwindow.addEventListener('unhandledrejection', (e) => {\r\n  showError(new Error(String(e.reason)));\r\n});\r\n\r\n// Load map data\r\nasync function loadMap(mapId: string): Promise<GameState> {\r\n  try {\r\n    const response = await fetch(`/src/data/maps/${mapId}.v1.json`);\r\n    const data = await response.json();\r\n    const mapData = validateMapSchema(data);\r\n    // Validate map content for runtime issues (duplicate IDs, OOB entities, missing metadata)\r\n    validateMapContent(mapData);\r\n    \r\n    // Create entities from map data\r\n    const entities: Entity[] = mapData.entities.map((e: any) => {\r\n      const base = {\r\n        id: e.id as EntityId,\r\n        tag: e.tag as any,\r\n        position: { x: e.x, y: e.y },\r\n        solid: e.solid,\r\n        metadata: e.metadata,\r\n      };\r\n      \r\n      if (e.tag === 'Player') {\r\n        return { ...base, tag: 'Player' as const, inventory: { items: [] }, facing: 'south' as const } as any;\r\n      } else if (e.tag === 'Chest') {\r\n        return { ...base, tag: 'Chest' as const, chestId: e.metadata.chestId, opened: e.metadata.opened ?? false, loot: e.metadata.loot ?? [] } as any;\r\n      } else if (e.tag === 'Door') {\r\n        return { ...base, tag: 'Door' as const, doorId: e.metadata.doorId, locked: e.metadata.locked ?? false, keyId: e.metadata.keyId } as any;\r\n      } else if (e.tag === 'Portal') {\r\n        return { ...base, tag: 'Portal' as const, targetMap: e.metadata.targetMap, targetPos: e.metadata.targetPos } as any;\r\n      } else if (e.tag === 'NPC') {\r\n        return { ...base, tag: 'NPC' as const, npcId: e.metadata.npcId, dialogId: e.metadata.dialogId } as any;\r\n      }\r\n      return base as any;\r\n    });\r\n    \r\n    // Create player entity\r\n    const playerEntity = {\r\n      id: 'player' as EntityId,\r\n      tag: 'Player' as const,\r\n      position: mapData.playerStart,\r\n      solid: true,\r\n      inventory: { items: [] },\r\n      facing: 'south' as const,\r\n    };\r\n    entities.push(playerEntity);\r\n    \r\n    return createState({\r\n      version: 1,\r\n      seed: Date.now(),\r\n      mapId: mapData.id,\r\n      mapWidth: mapData.width,\r\n      mapHeight: mapData.height,\r\n      tiles: mapData.tiles,\r\n      entities,\r\n      playerId: 'player' as EntityId,\r\n    });\r\n  } catch (e) {\r\n    throw new Error(`Failed to load map ${mapId}: ${e instanceof Error ? e.message : String(e)}`);\r\n  }\r\n}\r\n\r\n// Initialize game\r\nasync function init(): Promise<void> {\r\n  try {\r\n    const canvasEl = document.getElementById('game-canvas') as HTMLCanvasElement;\r\n    if (!canvasEl) throw new Error('Canvas element not found');\r\n    \r\n    const canvas = createCanvas(canvasEl);\r\n    const input = createInput(canvasEl);\r\n    const devOverlay = createDevOverlay();\r\n    \r\n    // Load initial state\r\n    let state = await loadMap('tutorial');\r\n    \r\n    // Create playtest menu\r\n    const playtestMenu = createPlaytestMenu((cmd: string, args: any[]) => {\r\n      if (cmd === 'teleport') {\r\n        state = teleportPlayer(state, args[0], args[1]);\r\n      } else if (cmd === 'addItem') {\r\n        state = addItemToInventory(state, args[0], args[1] || 1);\r\n      } else if (cmd === 'completeAllQuests') {\r\n        state = completeAllQuests(state);\r\n      } else if (cmd === 'resetQuests') {\r\n        state = resetQuests(state);\r\n      } else if (cmd === 'copyReplay') {\r\n        copyReplayToClipboard();\r\n      }\r\n      playtestMenu.update(state);\r\n    });\r\n    bindPlaytestMenuKey(playtestMenu);\r\n    \r\n    // Initialize playtest console in dev mode\r\n    if (config.DEV_CHECKS) {\r\n      createPlaytestConsole((cmd: string, args: any[]) => {\r\n        if (cmd === 'teleport') {\r\n          state = teleportPlayer(state, args[0], args[1]);\r\n        } else if (cmd === 'addItem') {\r\n          state = addItemToInventory(state, args[0], args[1] || 1);\r\n        } else if (cmd === 'completeAllQuests') {\r\n          state = completeAllQuests(state);\r\n        } else if (cmd === 'resetQuests') {\r\n          state = resetQuests(state);\r\n        } else if (cmd === 'copyReplay') {\r\n          copyReplayToClipboard();\r\n        }\r\n        return state;\r\n      });\r\n      // Init AI console (dev-only)\r\n      initAIConsole();\r\n      startReplay(state);\r\n      devOverlay.setPlaytestMode(true);\r\n      devOverlay.setReplayActive(true);\r\n    }\r\n    \r\n    // ðŸ”Œ PLUGIN POINT: Load plugins from config\r\n    const registry = createRegistry();\r\n    const plugins = [combatPlugin, shopPlugin, proceduralMapPlugin]; // Load from config.plugins\r\n    \r\n    for (const plugin of plugins) {\r\n      const ctx = { state, registry };\r\n      if (plugin.init) plugin.init(ctx);\r\n      if (plugin.onRegister) plugin.onRegister(registry);\r\n    }\r\n    \r\n    // Core systems\r\n    const systems = [\r\n      movementSystem,\r\n      interactionSystem,\r\n      clockSystem,\r\n      ...registry.getSystems(),\r\n    ];\r\n\r\n    // Initialize debug HUD (dev-only). Uses live snapshot of `state` and system names.\r\n    if (config.DEV_CHECKS) {\r\n      initDebugHUD(() => state, () => systems.map(s => (s as any).name || '<system>'));\r\n    }\r\n    \r\n    // Interaction handling\r\n    function handleInteraction(state: GameState): GameState {\r\n      const player = state.entities.find(e => e.id === state.playerId);\r\n      if (!player) return state;\r\n      \r\n      const interactable = findClosestInteractable(state, player.position);\r\n      if (!interactable) return state;\r\n      \r\n      let next = state;\r\n      \r\n      if (interactable.tag === 'Chest') {\r\n        const chest = interactable as any;\r\n        const chestId = chest.chestId || chest.metadata?.chestId;\r\n        if (chestId) {\r\n          next = openChest(next, chestId);\r\n          next = setQuestFlag(next, 'opened_chest', true);\r\n        }\r\n      } else if (interactable.tag === 'Door') {\r\n        const door = interactable as any;\r\n        const doorId = door.doorId || door.metadata?.doorId;\r\n        if (doorId) {\r\n          next = openDoor(next, doorId);\r\n        }\r\n      } else if (interactable.tag === 'NPC') {\r\n        const npc = interactable as any;\r\n        const npcId = npc.npcId || npc.metadata?.npcId;\r\n        if (npcId) {\r\n          next = setQuestFlag(next, `talked_to_${npcId}`, true);\r\n        }\r\n      } else if (interactable.tag === 'Portal') {\r\n        const portal = interactable as any;\r\n        const targetMap = portal.targetMap || portal.metadata?.targetMap;\r\n        const targetPos = portal.targetPos || portal.metadata?.targetPos;\r\n        if (targetMap) {\r\n          // Would load new map here\r\n          console.log(`Portal to ${targetMap} at ${JSON.stringify(targetPos)}`);\r\n        }\r\n      }\r\n      \r\n      return next;\r\n    }\r\n    \r\n    // Create render snapshot\r\n    function createSnapshot(state: GameState): RenderSnapshot {\r\n      const player = state.entities.find(e => e.id === state.playerId);\r\n      const interactions: Array<{ entityId: EntityId; message: string; position: { x: number; y: number } }> = [];\r\n      \r\n      if (player) {\r\n        const interactable = findClosestInteractable(state, player.position);\r\n        if (interactable) {\r\n          let message = 'Press E to interact';\r\n          if (interactable.tag === 'Chest') message = 'Press E to open chest';\r\n          else if (interactable.tag === 'Door') message = 'Press E to open door';\r\n          else if (interactable.tag === 'NPC') message = 'Press E to talk';\r\n          else if (interactable.tag === 'Portal') message = 'Press E to enter portal';\r\n          \r\n          interactions.push({\r\n            entityId: interactable.id,\r\n            message,\r\n            position: interactable.position,\r\n          });\r\n        }\r\n      }\r\n      \r\n      return {\r\n        state,\r\n        camera: { x: 0, y: 0, width: canvas.width, height: canvas.height },\r\n        interactions,\r\n      };\r\n    }\r\n    \r\n    // Game loop\r\n    let lastFrameTime = performance.now();\r\n    let frameCount = 0;\r\n    let fps = 60;\r\n    let stepTime = 0;\r\n    \r\n    const gameLoop = createGameLoop(\r\n      state,\r\n      systems,\r\n      {\r\n        onStep: (currentState: GameState, intent: Intent): GameState => {\r\n          const stepStart = performance.now();\r\n          \r\n          // Pre-step hooks\r\n          let next = currentState;\r\n          for (const plugin of plugins) {\r\n            if (plugin.onPreStep) {\r\n              next = plugin.onPreStep(next);\r\n            }\r\n          }\r\n          \r\n          // Handle special intents\r\n          if (intent.type === 'Interact') {\r\n            next = handleInteraction(next);\r\n          } else if (intent.type === 'Save') {\r\n            // Save game (would use save adapter)\r\n            console.log('Game saved');\r\n          } else if (intent.type === 'Load') {\r\n            // Load game (would use load adapter)\r\n            console.log('Game loaded');\r\n          }\r\n          \r\n          // Run step\r\n          next = step(next, intent, systems);\r\n          \r\n          // Post-step hooks\r\n          for (const plugin of plugins) {\r\n            if (plugin.onPostStep) {\r\n              next = plugin.onPostStep(next);\r\n            }\r\n          }\r\n          \r\n          // Invariants check (dev mode)\r\n          if (config.DEV_CHECKS) {\r\n            assertInvariants(next);\r\n          }\r\n          \r\n          stepTime = performance.now() - stepStart;\r\n          state = next;\r\n          return next;\r\n        },\r\n        onRender: (currentState: GameState): void => {\r\n          const intent = input.getIntent();\r\n          \r\n          // Update FPS\r\n          frameCount++;\r\n          const now = performance.now();\r\n          if (now - lastFrameTime >= 1000) {\r\n            fps = frameCount;\r\n            frameCount = 0;\r\n            lastFrameTime = now;\r\n          }\r\n          \r\n          // Render\r\n          const snap = createSnapshot(currentState);\r\n          draw(canvas.ctx, snap);\r\n          drawHUD(canvas.ctx, snap);\r\n          \r\n          // Plugin UI hooks\r\n          for (const plugin of plugins) {\r\n            if (plugin.ui?.draw) {\r\n              plugin.ui.draw(canvas.ctx, snap);\r\n            }\r\n            if (plugin.ui?.hud) {\r\n              const hud = { addText: () => {}, addBar: () => {}, addPrompt: () => {} } as any;\r\n              plugin.ui.hud(hud, snap);\r\n            }\r\n          }\r\n          \r\n          // Dev overlay\r\n          devOverlay.update(currentState, fps, stepTime);\r\n        },\r\n      },\r\n      () => input.getIntent()\r\n    );\r\n    \r\n    // Handle resize\r\n    window.addEventListener('resize', () => {\r\n      canvas.resize();\r\n    });\r\n    \r\n    // Prevent context menu on mobile\r\n    canvasEl.addEventListener('contextmenu', (e) => e.preventDefault());\r\n    \r\n  } catch (e) {\r\n    showError(e instanceof Error ? e : new Error(String(e)));\r\n  }\r\n}\r\n\r\n// Start game\r\ninit();\r\n"],"names":["config","createCanvas","canvas","dpr","width","height","resize","ctx","createInput","currentIntent","keys","touchStart","touchRepeatTimer","handleKeyDown","e","updateIntent","handleKeyUp","k","handleTouchStart","handleTouchMove","touch","dx","dy","deadzone","handleTouchEnd","createGameLoop","initialState","systems","callbacks","getIntent","state","accumulator","lastTime","stepMs","maxStepMs","frame","now","deltaMs","rafId","intent","assert","condition","message","assertDefined","value","TILE_FLOOR","TILE_WALL","TILE_PORTAL","createState","params","entitiesById","entity","createClock","time","totalMinutes","day","hour","minute","updateEntities","entities","updateEntity","id","updater","updated","setQuestFlag","key","getPlayer","player","drawGlyph","x","y","size","glyph","draw","snap","tileSize","tile","px","py","drawEntity","color","createHUDComposer","elements","text","max","position","el","ratio","drawHUD","hud","minViewportLeft","offsetX","canvasEl","rect","maxX","itemCount","sum","stack","clock","hint","overlayVisible","overlayEl","playtestMode","replayActive","createDevOverlay","update","fps","stepTime","lines","v","line","toggle","destroy","setPlaytestMode","enabled","setReplayActive","active","inBounds","getTile","tiles","isWalkable","isBlocked","pos","excludeId","canMoveTo","movePosition","direction","handleMove","newPos","handleInteract","handleUseItem","handleNone","CommandRegistry","type","handler","step","next","system","validateMapSchema","data","map","playerStart","validateMapContent","ids","meta","movementSystem","clockSystem","interactionSystem","findClosestInteractable","interactables","closest","minDist","dist","addItem","itemId","count","items","existing","i","hasItem","openChest","chestId","chest","c","openDoor","doorId","door","createRegistry","commands","triggers","name","s","calculateDamage","attackerPower","defenderDefense","mitigated","hit","handleAttack","enemyId","combatRules","combatState","combatPlugin","reg","shopState","shopPlugin","actor","proceduralMaps","generateCaveTiles","seed","rng","seededRandom","isEdge","iter","newTiles","wallCount","generateDungeonTiles","roomCount","rooms","w","h","overlaps","room","ry","rx","prev","curr","cx","cy","generateMazeTiles","corridorChance","visited","getNeighbors","cell","neighbors","current","wall","generateEntities","difficulty","biome","floorTiles","j","entityCount","playerPos","chestCount","npcCount","doorCount","generateProceduralMap","proceduralMapPlugin","newState","currentReplay","exportReplay","copyReplayToClipboard","json","teleportPlayer","p","completeAllQuests","result","resetQuests","addItemToInventory","idx","menuEl","menuVisible","currentState","onCommand","createPlaytestMenu","onCommandFn","hide","renderMenu","content","btn","cmd","args","a","num","show","bindPlaytestMenuKey","menu","AI_SERVER_URL","errorOverlay","showError","error","loadMap","mapId","mapData","base","playerEntity","init","handleInteraction","interactable","npc","npcId","portal","targetMap","targetPos","createSnapshot","interactions","input","devOverlay","playtestMenu","registry","plugins","plugin","lastFrameTime","frameCount","gameLoop","stepStart"],"mappings":"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"}