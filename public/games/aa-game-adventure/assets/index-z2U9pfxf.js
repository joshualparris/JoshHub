(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&o(r)}).observe(document,{childList:!0,subtree:!0});function n(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(i){if(i.ep)return;i.ep=!0;const s=n(i);fetch(i.href,s)}})();const x={tileSize:32,palette:{floor:"#3a3a3a",wall:"#1a1a1a",player:"#4a9eff",npc:"#ffaa44",chest:"#8b4513",door:"#654321",portal:"#9b59b6",text:"#ffffff",bg:"#1a1a1a"},fixedStepMs:16.6667,maxStepTimeMs:100,keys:{moveNorth:["KeyW","ArrowUp"],moveSouth:["KeyS","ArrowDown"],moveEast:["KeyD","ArrowRight"],moveWest:["KeyA","ArrowLeft"],interact:["KeyE","Space"],inventory:["KeyI"],save:["KeyF5"],load:["KeyF9"],devOverlay:["F1"]},touchDeadzone:20,touchRepeatMs:150,DEV_CHECKS:!1,SHOW_GRID:!1,SHOW_COLLIDERS:!1,REDUCED_MOTION:!1,plugins:["combat","shop"]};function Z(t){let e=window.devicePixelRatio||1,n=t.clientWidth,o=t.clientHeight;function i(){e=window.devicePixelRatio||1,n=t.clientWidth,o=t.clientHeight,t.width=n*e,t.height=o*e;const r=t.getContext("2d");r&&(r.scale(e,e),r.imageSmoothingEnabled=!1)}i();const s=t.getContext("2d");if(!s)throw new Error("Failed to get 2D context");return s.scale(e,e),s.imageSmoothingEnabled=!1,{canvas:t,ctx:s,get width(){return n},get height(){return o},get dpr(){return e},resize:i}}function tt(t){let e={type:"None"};const n=new Set;let o=null,i=null;function s(a){n.add(a.code),p()}function r(a){n.delete(a.code),p()}function p(){x.keys.moveNorth.some(a=>n.has(a))?e={type:"Move",direction:"north"}:x.keys.moveSouth.some(a=>n.has(a))?e={type:"Move",direction:"south"}:x.keys.moveEast.some(a=>n.has(a))?e={type:"Move",direction:"east"}:x.keys.moveWest.some(a=>n.has(a))?e={type:"Move",direction:"west"}:x.keys.interact.some(a=>n.has(a))?e={type:"Interact"}:x.keys.inventory.some(a=>n.has(a))?e={type:"OpenInventory"}:x.keys.save.some(a=>n.has(a))?e={type:"Save"}:x.keys.load.some(a=>n.has(a))?e={type:"Load"}:e={type:"None"}}function d(a){a.preventDefault(),a.touches.length>0&&(o={x:a.touches[0].clientX,y:a.touches[0].clientY})}function c(a){if(a.preventDefault(),!o||a.touches.length===0)return;const g=a.touches[0],l=g.clientX-o.x,f=g.clientY-o.y,M=x.touchDeadzone;Math.abs(l)>Math.abs(f)?l>M?e={type:"Move",direction:"east"}:l<-M&&(e={type:"Move",direction:"west"}):f>M?e={type:"Move",direction:"south"}:f<-M&&(e={type:"Move",direction:"north"}),i&&clearTimeout(i),i=window.setTimeout(()=>{p()},x.touchRepeatMs)}function u(a){a.preventDefault(),o=null,i&&(clearTimeout(i),i=null),e={type:"None"}}return window.addEventListener("keydown",s),window.addEventListener("keyup",r),t.addEventListener("touchstart",d,{passive:!1}),t.addEventListener("touchmove",c,{passive:!1}),t.addEventListener("touchend",u,{passive:!1}),{getIntent:()=>e,destroy:()=>{window.removeEventListener("keydown",s),window.removeEventListener("keyup",r),t.removeEventListener("touchstart",d),t.removeEventListener("touchmove",c),t.removeEventListener("touchend",u),i&&clearTimeout(i)}}}function et(t,e,n,o){let i=t,s=0,r=performance.now();const p=x.fixedStepMs,d=x.maxStepTimeMs;let c={type:"None"};function u(g){const l=Math.min(g-r,d);for(r=g,s+=l,c=o();s>=p;)i=n.onStep(i,c),s-=p,c={type:"None"};n.onRender(i),requestAnimationFrame(u)}const a=requestAnimationFrame(u);return{setIntent:g=>{c=g},stop:()=>{cancelAnimationFrame(a)}}}function k(t,e){if(!t)throw new Error(`Assertion failed: ${e}`)}function Q(t,e){if(t==null)throw new Error(`Assertion failed: ${e} (value was ${t})`)}const U=0,F=1,G=2;function J(t){const e=new Map;for(const n of t.entities)e.set(n.id,n);return{version:t.version,seed:t.seed,tick:0,mapId:t.mapId,mapWidth:t.mapWidth,mapHeight:t.mapHeight,tiles:t.tiles,entities:t.entities,entitiesById:e,playerId:t.playerId,questFlags:t.questFlags??{},clock:V(0)}}function V(t){const e=Math.floor(t/60),n=Math.floor(e/1440),o=Math.floor(e%1440/60),i=e%60;return{time:t,day:n,hour:o,minute:i}}function nt(t,e){const n=new Map;for(const o of e)n.set(o.id,o);for(const o of e)n.set(o.id,o);return{...t,entities:e,entitiesById:n}}function C(t,e,n){const o=t.entitiesById.get(e);Q(o,`Entity ${e} not found`);const i=n(o),s=t.entities.map(r=>r.id===e?i:r);return nt(t,s)}function _(t,e,n){return{...t,questFlags:{...t.questFlags,[e]:n}}}function $(t){const e=t.entitiesById.get(t.playerId);return Q(e,"Player entity not found"),k(e.tag==="Player","Player entity has wrong tag"),e}function ot(t,e,n,o,i){t.fillStyle="#ffffff",t.font=`${i*.6}px monospace`,t.textAlign="center",t.textBaseline="middle";let s="?";e.tag==="Player"?s="@":e.tag==="NPC"?s="N":e.tag==="Chest"?s=e.metadata?.opened?"=":"C":e.tag==="Door"?s=e.metadata?.locked?"#":"/":e.tag==="Portal"?s="O":e.tag==="Item"&&(s="i"),t.fillText(s,n+i/2,o+i/2)}function it(t,e){const{state:n}=e,o=x.tileSize;t.fillStyle=x.palette.bg,t.fillRect(0,0,t.canvas.width,t.canvas.height);for(let i=0;i<n.mapHeight;i++)for(let s=0;s<n.mapWidth;s++){const r=n.tiles[i*n.mapWidth+s],p=s*o,d=i*o;r===U?t.fillStyle=x.palette.floor:r===F?t.fillStyle=x.palette.wall:r===G?t.fillStyle=x.palette.portal:t.fillStyle=x.palette.floor,t.fillRect(p,d,o,o)}for(const i of n.entities)st(t,i,o)}function st(t,e,n){const o=e.position.x*n,i=e.position.y*n;let s=x.palette.player;e.tag==="NPC"?s=x.palette.npc:e.tag==="Chest"?s=x.palette.chest:e.tag==="Door"?s=x.palette.door:e.tag==="Portal"&&(s=x.palette.portal),t.fillStyle=s,t.fillRect(o+2,i+2,n-4,n-4),ot(t,e,o,i,n)}function rt(t){const e=[];return{addText(n,o,i,s){e.push({type:"text",x:n,y:o,text:i,color:s})},addBar(n,o,i,s,r,p){e.push({type:"bar",x:n,y:o,width:i,value:s,max:r,color:p})},addPrompt(n,o){e.push({type:"prompt",x:0,y:0,text:n,position:o})},draw(){for(const n of e)if(n.type==="text"&&n.text)t.fillStyle=n.color??x.palette.text,t.font="14px monospace",t.fillText(n.text,n.x,n.y);else if(n.type==="bar"&&n.value!==void 0&&n.max!==void 0){const o=Math.max(0,Math.min(1,n.value/n.max));t.fillStyle=n.color??"#ff0000",t.fillRect(n.x,n.y,n.width*o,8),t.strokeStyle=x.palette.text,t.strokeRect(n.x,n.y,n.width,8)}else if(n.type==="prompt"&&n.text&&n.position){const o=x.tileSize,i=n.position.x*o,s=n.position.y*o-20;t.fillStyle=x.palette.text,t.font="12px monospace",t.textAlign="center",t.fillText(n.text,i+o/2,s)}}}}function at(t,e){const n=rt(t),o=$(e.state),i=40;let s=40;try{const d=t.canvas,c=d.getBoundingClientRect();c.left<i?s=Math.ceil(i-c.left):s=16;const u=Math.max(16,Math.floor((d.width||d.clientWidth)-80));s=Math.min(s,u)}catch{}const r=o.inventory.items.reduce((d,c)=>d+c.count,0);n.addText(s,20,`Items: ${r}`,x.palette.text);const p=e.state.clock;n.addText(s,40,`Day ${p.day} ${p.hour}:${String(p.minute).padStart(2,"0")}`,x.palette.text);for(const d of e.interactions)n.addPrompt(d.message,d.position);n.draw()}let R=!1,E=null,L=!1,B=!1;function lt(){E||(E=document.createElement("div"),E.id="dev-overlay",E.style.cssText=`
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: #00ff00;
      padding: 10px;
      font-family: monospace;
      font-size: 12px;
      z-index: 9999;
      border: 1px solid #00ff00;
      display: none;
      max-width: 300px;
    `,document.body.appendChild(E));function t(s,r,p){if(!E||!R)return;const d=[`FPS: ${r.toFixed(1)}`,`Step: ${p.toFixed(2)}ms`,`Tick: ${s.tick}`,`Entities: ${s.entities.length}`,`Map: ${s.mapId}`,`Player: (${s.entities.find(c=>c.id===s.playerId)?.position.x}, ${s.entities.find(c=>c.id===s.playerId)?.position.y})`,`Seed: ${s.seed}`,`Flags: ${Object.keys(s.questFlags).length}`,`Clock: Day ${s.clock.day} ${s.clock.hour}:${String(s.clock.minute).padStart(2,"0")}`,"",L?"[PLAYTEST MODE]":"",B?"[REPLAY RECORDING]":"",L?"Commands: playtest.help()":"","","Flags:",...Object.entries(s.questFlags).map(([c,u])=>`  ${c}: ${u}`)].filter(c=>c!=="");E.textContent=d.join(`
`)}function e(){R=!R,E&&(E.style.display=R?"block":"none")}function n(){E&&(E.remove(),E=null)}function o(s){L=s}function i(s){B=s}return window.addEventListener("keydown",s=>{s.code==="F1"&&(s.preventDefault(),e())}),{update:t,toggle:e,destroy:n,setPlaytestMode:o,setReplayActive:i}}function X(t,e,n,o){return t>=0&&t<n&&e>=0&&e<o}function dt(t,e,n,o,i){return X(e,n,o,i)?t[n*o+e]??F:F}function ct(t){return t===U||t===G}function pt(t,e,n){for(const o of e)if(o.id!==n&&o.solid&&o.position.x===t.x&&o.position.y===t.y)return!0;return!1}function ut(t,e,n,o,i,s){if(!X(t.x,t.y,n,o))return!1;const r=dt(e,t.x,t.y,n,o);return!(!ct(r)||pt(t,i,s))}function ft(t,e){switch(e){case"north":return{x:t.x,y:t.y-1};case"south":return{x:t.x,y:t.y+1};case"east":return{x:t.x+1,y:t.y};case"west":return{x:t.x-1,y:t.y}}}function yt(t,e){if(e.type!=="Move")return t;const n=$(t),o=ft(n.position,e.direction);return ut(o,t.tiles,t.mapWidth,t.mapHeight,t.entities,n.id)?C(t,n.id,i=>({...i,position:o,facing:e.direction})):t}function mt(t,e){return e.type!=="Interact",t}function gt(t,e){return e.type!=="UseItem",t}function H(t,e){return t}class ht{handlers=new Map;constructor(){this.register("Move",yt),this.register("Interact",mt),this.register("UseItem",gt),this.register("None",H)}register(e,n){this.handlers.set(e,n)}handle(e,n){return(this.handlers.get(n.type)??H)(e,n)}}function xt(t,e,n){let i=new ht().handle(t,e);for(const s of n)i=s(i);return i={...i,tick:i.tick+1},i}function bt(t){k(typeof t=="object"&&t!==null,"Map data must be an object");const e=t;k(e.version===1,"Map version must be 1"),k(typeof e.id=="string","Map id must be a string"),k(typeof e.width=="number"&&e.width>0,"Map width must be a positive number"),k(typeof e.height=="number"&&e.height>0,"Map height must be a positive number"),k(Array.isArray(e.tiles),"Map tiles must be an array"),k(e.tiles.length===e.width*e.height,"Map tiles length must match width * height"),k(Array.isArray(e.entities),"Map entities must be an array"),k(typeof e.playerStart=="object"&&e.playerStart!==null,"Map playerStart must be an object");const n=e.playerStart;return k(typeof n.x=="number","Player start x must be a number"),k(typeof n.y=="number","Player start y must be a number"),e}function vt(t){const e=new Set;for(const n of t.entities){if(e.has(n.id))throw new Error(`Duplicate entity id '${n.id}' in map '${t.id}'. Check your map JSON (data/maps/${t.id}.v1.json) and ensure entity IDs are unique.`);e.add(n.id)}for(const n of t.entities){if(n.x<0||n.x>=t.width||n.y<0||n.y>=t.height)throw new Error(`Entity '${n.id}' is out of bounds at (${n.x},${n.y}) in map '${t.id}'. Check map dimensions (width=${t.width}, height=${t.height}) and entity coordinates.`);const o=n.metadata??{};if(n.tag==="Chest"&&(!o||typeof o.chestId!="string"))throw new Error(`Chest entity '${n.id}' missing required metadata.chestId in map '${t.id}'. Add a string metadata.chestId to the chest definition.`);if(n.tag==="Door"&&(!o||typeof o.doorId!="string"))throw new Error(`Door entity '${n.id}' missing required metadata.doorId in map '${t.id}'. Add a string metadata.doorId to the door definition.`);if(n.tag==="Portal"&&(!o||typeof o.targetMap!="string"))throw new Error(`Portal entity '${n.id}' missing required metadata.targetMap in map '${t.id}'. Add metadata.targetMap (string) to point to another map id.`);if(n.tag==="NPC"&&(!o||typeof o.npcId!="string"))throw new Error(`NPC entity '${n.id}' missing required metadata.npcId in map '${t.id}'. Add metadata.npcId (string) to identify the NPC.`)}}function It(t){return t}function wt(t){const e=t.tick*.0166667;return{...t,clock:V(e)}}function Mt(t){return t}function j(t,e){const n=t.entities.filter(s=>s.tag==="NPC"||s.tag==="Chest"||s.tag==="Door"||s.tag==="Portal");if(n.length===0)return null;let o=null,i=1/0;for(const s of n){const r=Math.abs(s.position.x-e.x)+Math.abs(s.position.y-e.y);r<i&&r<=1&&(i=r,o=s)}return o}function St(t,e,n){const o=$(t),i=[...o.inventory.items],s=i.findIndex(r=>r.itemId===e);return s>=0?i[s]={...i[s],count:i[s].count+n}:i.push({itemId:e,count:n}),C(t,o.id,r=>({...r,inventory:{items:i}}))}function Et(t,e,n=1){const i=$(t).inventory.items.find(s=>s.itemId===e);return i!==void 0&&i.count>=n}function kt(t,e){const n=t.entities.find(i=>i.tag==="Chest"&&i.chestId===e);if(!n||n.opened)return t;let o=C(t,n.id,i=>{const s=i;return{...s,opened:!0,metadata:{...s.metadata||{},opened:!0}}});for(const i of n.loot)o=St(o,i.itemId,i.count);return o}function Ct(t,e){const n=t.entities.find(o=>o.tag==="Door"&&o.doorId===e);return n?n.locked?n.keyId&&!Et(t,n.keyId)?t:C(t,n.id,o=>({...o,solid:!1,metadata:{...o.metadata||{},locked:!1}})):C(t,n.id,o=>({...o,solid:!1})):t}function $t(){const t=[],e=new Map,n=new Map;return{registerSystem(o,i){t.push({name:o,fn:i})},registerCommand(o,i){e.set(o,i)},registerTrigger(o,i){n.set(o,i)},getSystems(){return t.map(o=>o.fn)},getCommand(o){return e.get(o)},getTrigger(o){return n.get(o)}}}function Pt(t,e){const o=Math.max(1,t-e),i=Math.random()>.2;return{damage:i?o:0,hit:i}}function Tt(t,e){return t}const Rt={calculateDamage:Pt,handleAttack:Tt};let D={inCombat:!1};const Dt={id:"combat",init(t){D={inCombat:!1}},onRegister(t){t.registerSystem("combat",e=>e),t.registerCommand("Attack",(e,n)=>D.inCombat?Rt.handleAttack(e,D.enemyId):e)},onPreStep(t){return t},onPostStep(t){return t},ui:{hud(t,e){D.inCombat&&t.addText(10,60,"COMBAT MODE","#ff0000")}}};let P={open:!1};const At={id:"shop",init(t){P={open:!1}},onRegister(t){t.registerTrigger("shop",(e,n,o)=>(n.tag==="NPC"&&n.shopId&&(P.open=!0,P.shopId=n.shopId),e)),t.registerCommand("Buy",(e,n)=>(P.open&&n.type,e))},ui:{hud(t,e){P.open&&t.addText(10,80,"SHOP OPEN - Press E to buy","#00ff00")}}};let z=new Map;function Lt(t,e,n){const o=[],i=T(n);for(let s=0;s<e;s++)for(let r=0;r<t;r++){const p=r===0||s===0||r===t-1||s===e-1;o.push(p||i()<.45?1:0)}for(let s=0;s<4;s++){const r=[...o];for(let p=1;p<e-1;p++)for(let d=1;d<t-1;d++){let c=0;for(let u=-1;u<=1;u++)for(let a=-1;a<=1;a++)o[(p+u)*t+(d+a)]===1&&c++;r[p*t+d]=c>=5?1:0}o.splice(0,o.length,...r)}return o}function W(t,e,n,o){const i=[],s=T(n);for(let p=0;p<e;p++)for(let d=0;d<t;d++)i.push(1);const r=[];for(let p=0;p<o;p++){const d=4+Math.floor(s()*6),c=4+Math.floor(s()*6),u=2+Math.floor(s()*(t-d-4)),a=2+Math.floor(s()*(e-c-4));let g=!1;for(const l of r)if(u<l.x+l.w+2&&u+d+2>l.x&&a<l.y+l.h+2&&a+c+2>l.y){g=!0;break}if(!g){r.push({x:u,y:a,w:d,h:c});for(let l=a;l<a+c;l++)for(let f=u;f<u+d;f++)i[l*t+f]=0}}for(let p=1;p<r.length;p++){const d=r[p-1],c=r[p],u=Math.floor(d.x+d.w/2),a=Math.floor(d.y+d.h/2),g=Math.floor(c.x+c.w/2),l=Math.floor(c.y+c.h/2);for(let f=Math.min(u,g);f<=Math.max(u,g);f++)i[a*t+f]=0;for(let f=Math.min(a,l);f<=Math.max(a,l);f++)i[f*t+g]=0}return i}function Nt(t,e,n,o){const i=[],s=T(n);for(let u=0;u<e;u++)for(let a=0;a<t;a++)i.push(1);const r=new Array(t*e).fill(!1),p=[];function d(u){const a=u%t,g=Math.floor(u/t),l=[];return a>1&&!r[u-2]&&l.push(u-2),a<t-2&&!r[u+2]&&l.push(u+2),g>1&&!r[u-t*2]&&l.push(u-t*2),g<e-2&&!r[u+t*2]&&l.push(u+t*2),l}let c=t+1;for(r[c]=!0,i[c]=0,p.push(c);p.length>0;){const u=d(c);if(u.length>0){const a=u[Math.floor(s()*u.length)],g=(c+a)/2;r[a]=!0,i[a]=0,i[g]=0,p.push(a),c=a}else c=p.pop()}for(let u=2;u<e-2;u+=2)for(let a=2;a<t-2;a+=2)s()<o&&i[u*t+a]===1&&(i[u*t+a]=0);return i}function Ot(t,e,n,o,i,s){const r=[],p=T(o+1e3),d=[];for(let l=0;l<t.length;l++)t[l]===0&&d.push(l);for(let l=d.length-1;l>0;l--){const f=Math.floor(p()*(l+1));[d[l],d[f]]=[d[f],d[l]]}const c=Math.floor(d.length*(.05+i*.02));if(d.length>0){const l=d[0],f=l%e,M=Math.floor(l/e);r.push({id:"player",tag:"Player",position:{x:f,y:M},solid:!0})}const u=Math.max(1,Math.floor(c*(.1+p()*.1)));for(let l=0;l<u&&l+1<d.length;l++){const f=d[l+1],M=f%e,y=Math.floor(f/e);r.push({id:`chest_${l}`,tag:"Chest",position:{x:M,y},solid:!0,metadata:{chestId:`procedural_chest_${l}`,opened:!1,loot:[{itemId:"gold",count:10+Math.floor(p()*50)}]}})}const a=Math.max(0,Math.floor(c*(.05+p()*.05)));for(let l=0;l<a&&l+u+1<d.length;l++){const f=d[l+u+1],M=f%e,y=Math.floor(f/e);r.push({id:`npc_${l}`,tag:"NPC",position:{x:M,y},solid:!0,metadata:{npcId:`procedural_npc_${l}`,dialogId:`procedural_dialog_${l}`}})}const g=Math.max(0,Math.floor(c*(.02+p()*.03)));for(let l=0;l<g&&l+u+a+1<d.length;l++){const f=d[l+u+a+1],M=f%e,y=Math.floor(f/e);r.push({id:`door_${l}`,tag:"Door",position:{x:M,y},solid:!0,metadata:{doorId:`procedural_door_${l}`,locked:p()<.3,keyId:p()<.5?`key_${l}`:void 0}})}return r}function Ft(t){const{width:e=32,height:n=18,seed:o=Date.now(),difficulty:i=5,biome:s="dungeon",roomCount:r=8,corridorChance:p=.1}=t;let d=[];switch(s){case"cave":d=Lt(e,n,o);break;case"maze":d=Nt(e,n,o,p);break;case"dungeon":case"ruins":d=W(e,n,o,r);break;case"forest":const a=T(o);for(let g=0;g<n;g++)for(let l=0;l<e;l++){const f=l===0||g===0||l===e-1||g===n-1;d.push(f||a()<.2?1:0)}break;default:d=W(e,n,o,r)}const c=Ot(d,e,n,o,i);return c.find(a=>a.id==="player")?.position,J({version:1,seed:o,mapId:`procedural_${s}_${o}`,mapWidth:e,mapHeight:n,tiles:d,entities:c,playerId:"player"})}function T(t){let e=t;return()=>(e=(e*9301+49297)%233280,e/233280)}const _t={id:"procedural-map",init(t){z.clear()},onRegister(t){t.registerCommand("GenerateProceduralMap",(e,n)=>{if(n.type==="GenerateProceduralMap"){const o=n.params,i=Ft(o);return z.set(i.mapId,i),i}return e}),t.registerSystem("procedural-map-generator",e=>e)},onPreStep(t){return t}};let K=null;function qt(){return K?JSON.stringify(K,null,2):"No replay recorded"}function Bt(){const t=qt();navigator.clipboard.writeText(t).then(()=>{console.log("Replay copied to clipboard")})}function Ht(t,e,n){const o=$(t);return C(t,o.id,i=>({...i,position:{x:e,y:n}}))}function jt(t){let e=t;for(const n of Object.keys(t.questFlags))e=_(e,n,!0);return e}function zt(t){return{...t,questFlags:{}}}function Wt(t,e,n=1){const o=$(t),i=[...o.inventory.items],s=i.findIndex(r=>r.itemId===e);return s>=0?i[s]={...i[s],count:i[s].count+n}:i.push({itemId:e,count:n}),C(t,o.id,r=>({...r,inventory:{items:i}}))}let I=null,A=!1,w=null,N=null;function Kt(t){N=t,I||(I=document.createElement("div"),I.id="playtest-menu",I.style.cssText=`
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.95);
      border: 2px solid #00ff00;
      color: #00ff00;
      padding: 20px;
      font-family: monospace;
      font-size: 14px;
      z-index: 9998;
      display: none;
      max-height: 80vh;
      overflow-y: auto;
      min-width: 400px;
      box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
    `,I.innerHTML=`
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #00ff00; padding-bottom: 10px;">
        <h2 style="margin: 0;">PLAYTEST MENU</h2>
        <button id="close-menu" style="background: #00ff00; color: #000; border: none; padding: 5px 10px; cursor: pointer; font-family: monospace;">X</button>
      </div>
      <div id="menu-content"></div>
      <div style="margin-top: 15px; border-top: 1px solid #00ff00; padding-top: 10px; font-size: 12px; color: #88ff88;">
        <p>Press ESC to close | Console: playtest.help()</p>
      </div>
    `,document.body.appendChild(I),I.querySelector("#close-menu")?.addEventListener("click",()=>{o()}),window.addEventListener("keydown",r=>{r.code==="Escape"&&A&&o()}));function e(){if(!I||!w)return;const r=I.querySelector("#menu-content");if(!r)return;const d=w.entities.find(c=>c.id===w.playerId)?.position||{x:0,y:0};r.innerHTML=`
      <div style="margin-bottom: 15px;">
        <h3 style="margin: 0 0 10px 0;">Game State</h3>
        <p style="margin: 5px 0;"><strong>Seed:</strong> ${w.seed}</p>
        <p style="margin: 5px 0;"><strong>Map:</strong> ${w.mapId}</p>
        <p style="margin: 5px 0;"><strong>Tick:</strong> ${w.tick}</p>
        <p style="margin: 5px 0;"><strong>Player Position:</strong> (${d.x}, ${d.y})</p>
        <p style="margin: 5px 0;"><strong>Entities:</strong> ${w.entities.length}</p>
        <p style="margin: 5px 0;"><strong>Clock:</strong> Day ${w.clock.day} ${w.clock.hour}:${String(w.clock.minute).padStart(2,"0")}</p>
      </div>

      <div style="margin-bottom: 15px;">
        <h3 style="margin: 0 0 10px 0;">Movement</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
          <button class="menu-btn" data-cmd="teleport" data-args="0,0">Teleport to (0,0)</button>
          <button class="menu-btn" data-cmd="teleport" data-args="16,9">Center</button>
          <button class="menu-btn" data-cmd="teleport" data-args="${w.mapWidth-2},${w.mapHeight-2}">Bottom-Right</button>
          <button class="menu-btn" data-cmd="teleport" data-args="1,1">Top-Left</button>
        </div>
      </div>

      <div style="margin-bottom: 15px;">
        <h3 style="margin: 0 0 10px 0;">Inventory</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
          <button class="menu-btn" data-cmd="addItem" data-args="sword,1">Add Sword</button>
          <button class="menu-btn" data-cmd="addItem" data-args="shield,1">Add Shield</button>
          <button class="menu-btn" data-cmd="addItem" data-args="key,5">Add Keys (5)</button>
          <button class="menu-btn" data-cmd="addItem" data-args="potion,10">Add Potions (10)</button>
        </div>
      </div>

      <div style="margin-bottom: 15px;">
        <h3 style="margin: 0 0 10px 0;">Quests</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
          <button class="menu-btn" data-cmd="completeAllQuests">Complete All Quests</button>
          <button class="menu-btn" data-cmd="resetQuests">Reset Quests</button>
        </div>
      </div>

      <div style="margin-bottom: 15px;">
        <h3 style="margin: 0 0 10px 0;">Replay</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
          <button class="menu-btn" data-cmd="startReplay">Start Replay</button>
          <button class="menu-btn" data-cmd="copyReplay">Copy Replay</button>
        </div>
      </div>

      <div style="margin-bottom: 15px;">
        <h3 style="margin: 0 0 10px 0;">Quests Status</h3>
        ${Object.entries(w.questFlags).length===0?'<p style="color: #88ff88; font-size: 12px;">No quests active</p>':Object.entries(w.questFlags).map(([c,u])=>`<p style="margin: 3px 0; font-size: 12px;"><strong>${c}:</strong> ${u?"✓":"✗"}</p>`).join("")}
      </div>
    `,r.querySelectorAll(".menu-btn").forEach(c=>{c.addEventListener("click",()=>{const u=c.dataset.cmd,g=(c.dataset.args||"").split(",").map(l=>{const f=parseInt(l,10);return isNaN(f)?l:f});u&&N&&N(u,g)})})}function n(){A=!0,I&&(I.style.display="block",e())}function o(){A=!1,I&&(I.style.display="none")}function i(r){w=r,A&&e()}function s(){I&&(I.remove(),I=null)}return{show:n,hide:o,update:i,destroy:s}}function Qt(t){window.addEventListener("keydown",e=>{e.code==="F2"&&(e.preventDefault(),document.getElementById("playtest-menu")?.style.display==="block"?t.hide():t.show())})}const Jt=window.__AI_SERVER_URL__||"http://localhost:4873/ai";const O=document.getElementById("error-overlay");function q(t){O&&(O.classList.remove("hidden"),O.innerHTML=`
      <h2>Error</h2>
      <p>${t.message}</p>
      <pre>${t.stack||"No stack trace"}</pre>
    `),console.error(t)}window.addEventListener("error",t=>{q(t.error)});window.addEventListener("unhandledrejection",t=>{q(new Error(String(t.reason)))});async function Ut(t){try{const n=await(await fetch(`./maps/${t}.v1.json`)).json(),o=bt(n);vt(o);const i=o.entities.map(r=>{const p={id:r.id,tag:r.tag,position:{x:r.x,y:r.y},solid:r.solid,metadata:r.metadata};return r.tag==="Player"?{...p,tag:"Player",inventory:{items:[]},facing:"south"}:r.tag==="Chest"?{...p,tag:"Chest",chestId:r.metadata.chestId,opened:r.metadata.opened??!1,loot:r.metadata.loot??[]}:r.tag==="Door"?{...p,tag:"Door",doorId:r.metadata.doorId,locked:r.metadata.locked??!1,keyId:r.metadata.keyId}:r.tag==="Portal"?{...p,tag:"Portal",targetMap:r.metadata.targetMap,targetPos:r.metadata.targetPos}:r.tag==="NPC"?{...p,tag:"NPC",npcId:r.metadata.npcId,dialogId:r.metadata.dialogId}:p}),s={id:"player",tag:"Player",position:o.playerStart,solid:!0,inventory:{items:[]},facing:"south"};return i.push(s),J({version:1,seed:Date.now(),mapId:o.id,mapWidth:o.width,mapHeight:o.height,tiles:o.tiles,entities:i,playerId:"player"})}catch(e){throw new Error(`Failed to load map ${t}: ${e instanceof Error?e.message:String(e)}`)}}async function Gt(){try{let t=function(y){const b=y.entities.find(h=>h.id===y.playerId);if(!b)return y;const v=j(y,b.position);if(!v)return y;let m=y;if(v.tag==="Chest"){const h=v,S=h.chestId||h.metadata?.chestId;S&&(m=kt(m,S),m=_(m,"opened_chest",!0))}else if(v.tag==="Door"){const h=v,S=h.doorId||h.metadata?.doorId;S&&(m=Ct(m,S))}else if(v.tag==="NPC"){const h=v,S=h.npcId||h.metadata?.npcId;S&&(m=_(m,`talked_to_${S}`,!0))}else if(v.tag==="Portal"){const h=v,S=h.targetMap||h.metadata?.targetMap,Y=h.targetPos||h.metadata?.targetPos;S&&console.log(`Portal to ${S} at ${JSON.stringify(Y)}`)}return m},e=function(y){const b=y.entities.find(m=>m.id===y.playerId),v=[];if(b){const m=j(y,b.position);if(m){let h="Press E to interact";m.tag==="Chest"?h="Press E to open chest":m.tag==="Door"?h="Press E to open door":m.tag==="NPC"?h="Press E to talk":m.tag==="Portal"&&(h="Press E to enter portal"),v.push({entityId:m.id,message:h,position:m.position})}}return{state:y,camera:{x:0,y:0,width:o.width,height:o.height},interactions:v}};const n=document.getElementById("game-canvas");if(!n)throw new Error("Canvas element not found");const o=Z(n),i=tt(n),s=lt();let r=await Ut("tutorial");const p=Kt((y,b)=>{y==="teleport"?r=Ht(r,b[0],b[1]):y==="addItem"?r=Wt(r,b[0],b[1]||1):y==="completeAllQuests"?r=jt(r):y==="resetQuests"?r=zt(r):y==="copyReplay"&&Bt(),p.update(r)});Qt(p),x.DEV_CHECKS;const d=$t(),c=[Dt,At,_t];for(const y of c){const b={state:r,registry:d};y.init&&y.init(b),y.onRegister&&y.onRegister(d)}const u=[It,Mt,wt,...d.getSystems()];x.DEV_CHECKS;let a=performance.now(),g=0,l=60,f=0;const M=et(r,u,{onStep:(y,b)=>{const v=performance.now();let m=y;for(const h of c)h.onPreStep&&(m=h.onPreStep(m));b.type==="Interact"?m=t(m):b.type==="Save"?console.log("Game saved"):b.type==="Load"&&console.log("Game loaded"),m=xt(m,b,u);for(const h of c)h.onPostStep&&(m=h.onPostStep(m));return x.DEV_CHECKS,f=performance.now()-v,r=m,m},onRender:y=>{const b=i.getIntent();g++;const v=performance.now();v-a>=1e3&&(l=g,g=0,a=v);const m=e(y);it(o.ctx,m),at(o.ctx,m);for(const h of c)if(h.ui?.draw&&h.ui.draw(o.ctx,m),h.ui?.hud){const S={addText:()=>{},addBar:()=>{},addPrompt:()=>{}};h.ui.hud(S,m)}s.update(y,l,f)}},()=>i.getIntent());window.addEventListener("resize",()=>{o.resize()}),n.addEventListener("contextmenu",y=>y.preventDefault())}catch(t){q(t instanceof Error?t:new Error(String(t)))}}Gt();
//# sourceMappingURL=index-z2U9pfxf.js.map
