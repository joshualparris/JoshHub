(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))i(t);new MutationObserver(t=>{for(const o of t)if(o.type==="childList")for(const d of o.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&i(d)}).observe(document,{childList:!0,subtree:!0});function r(t){const o={};return t.integrity&&(o.integrity=t.integrity),t.referrerPolicy&&(o.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?o.credentials="include":t.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(t){if(t.ep)return;t.ep=!0;const o=r(t);fetch(t.href,o)}})();function _(e){let n=e||305419896;return()=>(n^=n<<13,n^=n>>>17,n^=n<<5,(n>>>0)/4294967295)}function R(e){if(!e.width||!e.height||!e.tiles||!e.entities)throw new Error("Map missing required fields");if(e.tiles.length!==e.width*e.height)throw new Error(`Map tiles length ${e.tiles.length} != ${e.width*e.height}`);const n=e.entities.find(r=>r.type==="player");if(!n)throw new Error("Map missing player entity");if(n.x<0||n.x>=e.width||n.y<0||n.y>=e.height)throw new Error("Player out of bounds");if(e.tiles[n.y*e.width+n.x]===1)throw new Error("Player spawned in wall")}function b(e,n=12345){R(e);const r=e.entities.find(o=>o.type==="player"),i=e.entities.filter(o=>o.type==="enemy").map(o=>({id:`${o.x}_${o.y}`,x:o.x,y:o.y,hp:o.hp||3,maxHp:o.hp||3,damage:o.damage||1,moveCooldown:0,type:o.enemyType||"goblin"})),t={up:0,down:0,left:0,right:0};return{t:0,rng:_(n),map:e,player:{x:r.x,y:r.y,hp:10,maxHp:10,damage:2},enemies:i,opened:new Set,inv:{},flags:{},inCombat:!1,combatTarget:null,moveAccum:t}}function F(e,n){if(!n)return null;const r=b(e,12345);return r.player=n.player,r.opened=n.opened,r.inv=n.inv,r.flags=n.flags,r}const E=100,B=80;function P(e,n,r,i){const t=[{x:e.x,y:e.y,path:[]}],o=new Set([`${e.x},${e.y}`]),d=[[0,-1],[0,1],[-1,0],[1,0]];for(;t.length>0;){const a=t.shift();if(a.x===n.x&&a.y===n.y)return a.path[0]||null;for(const[y,l]of d){const s=a.x+y,c=a.y+l,u=`${s},${c}`;o.has(u)||s<0||s>=r.width||c<0||c>=r.height||r.tiles[c*r.width+s]===1||i.some(w=>w.id!==e.id&&w.x===s&&w.y===c&&w.hp>0)||s===n.x&&c===n.y||(o.add(u),t.push({x:s,y:c,path:a.path.length===0?[{dx:y,dy:l}]:[...a.path,{dx:y,dy:l}]}))}}return null}function H(e,n){if(e={...e,t:e.t+1},e.inCombat&&e.combatTarget){const r=e.enemies.find(i=>i.id===e.combatTarget);(!r||r.hp<=0)&&(e.inCombat=!1,e.combatTarget=null)}return e.inCombat||(e.moveAccum||(e.moveAccum={up:0,down:0,left:0,right:0}),["up","down","left","right"].forEach(i=>{if(n[i]){e.moveAccum[i]+=16.6667;const t=e.moveAccum[i]<E?E:B;if(e.moveAccum[i]>=t){e.moveAccum[i]=0;let o=0,d=0;i==="up"?d=-1:i==="down"?d=1:i==="left"?o=-1:i==="right"&&(o=1);const a=e.player.x+o,y=e.player.y+d;if(a>=0&&a<e.map.width&&y>=0&&y<e.map.height){const l=y*e.map.width+a;if(e.map.tiles[l]===0){const s=e.enemies.find(c=>c.x===a&&c.y===y&&c.hp>0);s?(e.inCombat=!0,e.combatTarget=s.id):e.player={...e.player,x:a,y}}}}}else e.moveAccum[i]=0})),e.t%30===0&&!e.inCombat&&(e.enemies=e.enemies.map(r=>{if(r.hp<=0)return r;if(Math.abs(r.x-e.player.x)+Math.abs(r.y-e.player.y)<=1)return e.player.hp=Math.max(0,e.player.hp-r.damage),e.player.hp<=0&&(e.flags.gameOver=!0),r;const t=P(r,e.player,e.map,e.enemies);if(t){const o=r.x+t.dx,d=r.y+t.dy;return o===e.player.x&&d===e.player.y?(e.inCombat=!0,e.combatTarget=r.id,r):{...r,x:o,y:d}}return r})),e}function A(e,n,r,i){return Math.abs(e-r)+Math.abs(n-i)<=1}function q(e){const n=e.player.x,r=e.player.y,i=e.enemies.find(t=>t.hp>0&&A(n,r,t.x,t.y));if(i){if(i.hp=Math.max(0,i.hp-e.player.damage),i.hp<=0){const t=e.map.entities.find(o=>o.type==="enemy"&&o.x===i.x&&o.y===i.y);t&&t.loot&&t.loot.forEach(o=>{e.inv[o.id]=(e.inv[o.id]||0)+o.qty}),e.flags[`enemy_defeated_${i.id}`]=!0}return e}for(const t of e.map.entities){if(t.type==="player"||t.type==="enemy"||!A(n,r,t.x,t.y))continue;const o=`${t.type}_${t.x}_${t.y}`;switch(t.type){case"npc":e.flags[`dialog_${o}`]=!0;break;case"chest":e.opened.has(o)||(e.opened.add(o),t.loot&&t.loot.forEach(d=>{e.inv[d.id]=(e.inv[d.id]||0)+d.qty}));break;case"door":t.requires&&e.inv[t.requires]>0&&(e.inv[t.requires]--,e.inv[t.requires]===0&&delete e.inv[t.requires],e.flags.win=!0);break}}return e}function D(e){return{player:e.player,map:e.map,enemies:e.enemies||[],opened:e.opened,inv:e.inv,flags:e.flags,inCombat:e.inCombat||!1,combatTarget:e.combatTarget||null,moveAccum:e.moveAccum||{up:0,down:0,left:0,right:0}}}const f=32,K="#2a2a2a",N="#4a4a4a",W="#1a1a1a";function j(e,n,r){const{map:i,player:t,opened:o,inv:d,flags:a}=n;e.fillStyle="#1a1a1a",e.fillRect(0,0,i.width*f,i.height*f);for(let l=0;l<i.height;l++)for(let s=0;s<i.width;s++){const c=l*i.width+s,u=i.tiles[c]===1;e.fillStyle=u?K:N,e.fillRect(s*f,l*f,f,f),e.strokeStyle=W,e.lineWidth=1,e.strokeRect(s*f,l*f,f,f)}for(const l of n.enemies||[])if(!(l.hp<=0)&&(e.fillStyle="#ff4444",e.font=`${f*.8}px monospace`,e.textAlign="center",e.textBaseline="middle",e.fillText("☠",(l.x+.5)*f,(l.y+.5)*f),l.hp<l.maxHp)){const s=f*.6,c=4,u=l.hp/l.maxHp;e.fillStyle="#330000",e.fillRect((l.x+.2)*f,(l.y+.9)*f,s,c),e.fillStyle="#ff0000",e.fillRect((l.x+.2)*f,(l.y+.9)*f,s*u,c)}for(const l of i.entities){if(l.type==="player"||l.type==="enemy")continue;const s=`${l.type}_${l.x}_${l.y}`;e.fillStyle="#fff",e.font=`${f*.8}px monospace`,e.textAlign="center",e.textBaseline="middle";let c="?";l.type==="npc"?c="◎":l.type==="chest"?c=o.has(s)?"✓":"□":l.type==="door"&&(c="▥"),e.fillText(c,(l.x+.5)*f,(l.y+.5)*f)}e.fillStyle="#00ff00",e.fillRect(t.x*f+4,t.y*f+4,f-8,f-8),e.fillStyle="#fff",e.font="12px sans-serif",e.textAlign="left",e.textBaseline="top",e.fillText(`HP: ${n.player.hp}/${n.player.maxHp}`,8,8),e.fillText(`Keys: ${d.key_small||0}`,8,24),n.inCombat&&(e.fillStyle="#ff0000",e.font="14px sans-serif",e.textAlign="center",e.fillText("⚔ COMBAT ⚔",i.width*f/2,8),e.textAlign="left");let y=!1;for(const l of i.entities)if(l.type!=="player"&&Math.abs(t.x-l.x)+Math.abs(t.y-l.y)<=1){y=!0;break}y&&(e.fillStyle="#ffff00",e.fillText("Space to interact",8,i.height*f-20)),a.win&&(e.fillStyle="rgba(0,0,0,0.8)",e.fillRect(0,0,i.width*f,i.height*f),e.fillStyle="#fff",e.font="24px sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillText("You win!",i.width*f/2,i.height*f/2)),a.gameOver&&(e.fillStyle="rgba(0,0,0,0.9)",e.fillRect(0,0,i.width*f,i.height*f),e.fillStyle="#ff0000",e.font="24px sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillText("Game Over!",i.width*f/2,i.height*f/2-20),e.fillStyle="#fff",e.font="14px sans-serif",e.fillText("Press F5 to reload",i.width*f/2,i.height*f/2+20))}function G(){const e={up:!1,down:!1,left:!1,right:!1,interact:!1,inventory:!1,edgeInteract:!1,edgeInventory:!1};let n=!1,r=!1;const i={w:"up",W:"up",ArrowUp:"up",s:"down",S:"down",ArrowDown:"down",a:"left",A:"left",ArrowLeft:"left",d:"right",D:"right",ArrowRight:"right"," ":"interact",i:"inventory",I:"inventory"},t={KeyW:"up",KeyS:"down",KeyA:"left",KeyD:"right",ArrowUp:"up",ArrowDown:"down",ArrowLeft:"left",ArrowRight:"right",Space:"interact",KeyI:"inventory"};function o(a,y){let l=i[a.key]||t[a.code];l&&(a.preventDefault(),e[l]=y)}window.addEventListener("keydown",a=>o(a,!0)),window.addEventListener("keyup",a=>o(a,!1));function d(){const a=document.getElementById("mobile-pad");if(!a)return;const y={"btn-up":"up","btn-down":"down","btn-left":"left","btn-right":"right","btn-interact":"interact"};["mousedown","touchstart"].forEach(l=>{a.addEventListener(l,s=>{const c=s.target.id;y[c]&&(s.preventDefault(),e[y[c]]=!0)},{passive:!1})}),["mouseup","touchend","touchcancel"].forEach(l=>{a.addEventListener(l,s=>{const c=s.target.id;y[c]&&(s.preventDefault(),e[y[c]]=!1)},{passive:!1})})}return document.readyState==="loading"?document.addEventListener("DOMContentLoaded",d):d(),{get(){return e.edgeInteract=e.interact&&!n,e.edgeInventory=e.inventory&&!r,n=e.interact,r=e.inventory,e}}}const L=1,T="tilegame_save";function Y(e){const n={version:L,player:{x:e.player.x,y:e.player.y},opened:Array.from(e.opened),inv:{...e.inv},flags:{...e.flags}};try{localStorage.setItem(T,JSON.stringify(n))}catch(r){console.warn("Save failed:",r)}}function M(){try{const e=localStorage.getItem(T);if(!e)return null;const n=JSON.parse(e);return n.version!==L?null:{player:n.player,opened:new Set(n.opened||[]),inv:n.inv||{},flags:n.flags||{}}}catch{return null}}const g=document.getElementById("canvas"),O=g.getContext("2d"),m=Math.max(1,window.devicePixelRatio||1);let v=0,S=performance.now(),p=null,h=null;const z=G();async function $(){try{h=await(await fetch("./src/map.json")).json(),console.log("Map loaded:",h)}catch(e){throw console.error("Failed to load map:",e),e}}function C(){g.style.width="640px",g.style.height="384px",g.width=Math.round(640*m),g.height=Math.round(384*m),O.setTransform(m,0,0,m,0,0)}function x(e){const n=document.getElementById("error");n.textContent=e,n.style.display="block"}async function I(e){try{if(h||await $(),console.log("Starting game...",e),e){const n=M();p=n?F(h,n):b(h,12345)}else p=b(h,12345);console.log("Game state created:",p),document.getElementById("ui").style.display="none",console.log("Starting frame loop..."),k()}catch(n){console.error("Error starting game:",n),x("Failed to start: "+n.message+" (Check console for details)")}}(async()=>{try{await $(),document.getElementById("btn-start").addEventListener("click",()=>I(!1)),document.getElementById("btn-continue").addEventListener("click",()=>I(!0)),M()&&(document.getElementById("btn-continue").style.display="inline-block")}catch(e){console.error("Failed to initialize:",e),x("Failed to load game: "+e.message)}})();C();window.addEventListener("resize",C);function k(e=performance.now()){if(!p){console.error("No game state!");return}try{v+=Math.min(100,e-S),S=e;const n=z.get();for(;v>=16.6667;)n.edgeInteract&&(p=q(p)),p=H(p,n),v-=16.6667;j(O,D(p),m),requestAnimationFrame(k)}catch(n){console.error("Error in frame loop:",n),x("Game error: "+n.message)}}window.addEventListener("beforeunload",()=>{p&&Y(p)});
